<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FertiCore - Sistema de Visualização Agrícola</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-green: #7CB342;
            --secondary-green: #8BC34A;
            --dark-green: #689F38;
            --light-green: #DCEDC8;
            --accent-brown: #8D6E63;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #424242;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .sidebar {
            position: fixed;
            top: 70px;
            left: -280px;
            width: 280px;
            height: calc(100vh - 70px);
            background: var(--white);
            color: var(--dark-gray);
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            border-right: 1px solid var(--medium-gray);
            transition: left 0.3s ease;
        }

        .sidebar.active {
            left: 0;
        }

        /* Desktop: sidebar persistently visible on larger screens */
        @media (min-width: 992px) {
            .sidebar {
                left: 0;
            }
            .main-content {
                margin-left: 280px;
            }
        }

        .sidebar-header {
            padding: 25px 20px;
            background: var(--white);
            border-bottom: 2px solid var(--light-green);
            text-align: center;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .logo-image {
            width: 140px;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--white);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .logo-subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
            color: var(--black);
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
            margin-top: 20px;
        }

        .sidebar-menu li {
            border-bottom: 1px solid var(--medium-gray);
        }

        .sidebar-menu a {
            display: block;
            padding: 18px 25px;
            color: var(--dark-gray);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: var(--light-green);
            color: var(--dark-green);
            border-left-color: var(--primary-green);
            padding-left: 30px;
        }

        .sidebar-menu i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        .layers-section {
            padding: 25px 20px;
            border-top: 2px solid var(--light-green);
            background: var(--white);
        }

        .layers-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }

        .form-select {
            background: var(--white);
            border: 2px solid var(--light-green);
            color: var(--dark-gray);
            font-size: 14px;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            background: var(--white);
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 0.2rem rgba(124, 179, 66, 0.25);
            outline: none;
        }

        .form-select option {
            background: var(--white);
            color: var(--dark-gray);
        }

        .main-content {
            margin-left: 0;
            margin-right: 0px;
            margin-top: 70px;
            height: calc(100vh - 70px);
            position: relative;
            transition: margin-left 0.3s ease, margin-right 0.3s ease;
        }

        .main-content.analytics-visible {
            margin-right: 350px;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        /* Main Header */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: var(--white);
            border-bottom: 2px solid var(--light-green);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .hamburger-menu {
            background: none;
            border: 2px solid var(--primary-green);
            border-radius: 8px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-green);
            font-size: 18px;
        }

        .hamburger-menu:hover {
            background: var(--primary-green);
            color: var(--white);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-green);
            margin: 0;
        }

        .header-right {
            width: 45px; /* Para balancear o layout */
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }

        .map-legend {
            background: var(--white);
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 280px;
            font-size: 13px;
            border: 2px solid var(--primary-green);
        }

        .map-legend h6 {
            margin-bottom: 12px;
            color: var(--dark-green);
            font-weight: 600;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
        }

        .stats-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--light-green);
        }

        .stat-card {
            background: var(--light-green);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-green);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 12px;
            color: var(--dark-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: var(--dark-green);
            margin-top: 5px;
        }

        /* Grayscale map tiles */
        .grayscale-tiles {
            filter: grayscale(100%) contrast(1.1) brightness(1.0) sepia(0.1);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 70px;
                left: 0;
                width: calc(100vw - 80px) !important; /* Ocupa toda tela menos 80px de margem direita */
                max-width: 320px; /* Máximo de 320px para não ficar muito largo */
                height: calc(100vh - 70px);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 2000;
                border-top-right-radius: 15px;
                border-bottom-right-radius: 15px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                height: 100vh;
            }

            .toggle-sidebar {
                top: 15px;
                right: 15px;
                left: auto;
                width: 48px;
                height: 48px;
                z-index: 2100;
            }

            .layers-section {
                padding: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .layer-item {
                padding: 10px;
                margin-bottom: 8px;
            }

            .layer-controls {
                flex-wrap: wrap;
                gap: 5px;
            }

            .layer-controls .btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .analytics-card {
                position: relative !important;
                width: calc(100vw - 20px) !important;
                top: auto !important;
                left: auto !important;
                margin: 10px auto;
                max-height: 50vh;
                overflow-y: auto;
            }

            .analytics-content {
                font-size: 13px;
            }

            .analytics-section {
                margin-bottom: 12px;
                padding-bottom: 8px;
            }

            .analytics-value {
                font-size: 24px;
            }

            #map {
                height: calc(100vh - 70px) !important;
            }
        }

        @media (max-width: 480px) {
            .toggle-sidebar {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .sidebar-header {
                padding: 15px;
            }

            .logo-image {
                width: 120px;
            }

            .layers-section {
                padding: 10px;
            }

            .layer-item-name {
                font-size: 12px;
            }

            .layer-item-type {
                font-size: 10px;
            }

            .form-select, .form-control {
                font-size: 14px;
                padding: 8px 12px;
            }

            .modal-dialog {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }

            .modal-body .row .col-md-6 {
                margin-bottom: 15px;
            }
        }

        /* Melhorias gerais de UX */
        .btn:focus,
        .form-control:focus,
        .form-select:focus {
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(124, 179, 66, 0.25);
        }

        .layer-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .widget-btn:hover {
            transform: scale(1.1);
        }

        .form-control, .form-select {
            border-radius: 8px;
        }

        .btn {
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .sidebar {
            backdrop-filter: blur(10px);
        }

        /* Overlay para mobile quando sidebar está aberta */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            width: 100vw;
            height: calc(100vh - 70px);
            background: rgba(0,0,0,0.3);
            z-index: 1999;
        }

        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }

        /* Custom Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        /* Map Controls Styles */
        .leaflet-control-custom {
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }

        .leaflet-control-custom:hover {
            background: #f4f4f4;
        }

        .map-layer-control,
        .map-tools-control {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid var(--medium-gray);
            font-size: 13px;
        }

        .map-layer-control label:hover,
        .map-tools-control label:hover {
            background: var(--light-green);
            border-radius: 3px;
            padding: 2px;
        }

        .map-tools-control .btn {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .map-tools-control input[type="range"] {
            accent-color: var(--primary-green);
        }

        /* Coordinates display */
        #coordinates-display {
            transition: background-color 0.3s ease;
        }

        #coordinates-display:hover {
            background: var(--light-green) !important;
        }

        /* Fullscreen styles */
        #map:-webkit-full-screen {
            width: 100vw;
            height: 100vh;
        }

        #map:-moz-full-screen {
            width: 100vw;
            height: 100vh;
        }

        #map:fullscreen {
            width: 100vw;
            height: 100vh;
        }

        /* Map measurement styles */
        .leaflet-popup-content {
            font-size: 13px;
        }

        /* Remove duplicate overlay definition and keep unified one */


        /* Mobile Footer */
        .mobile-footer {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            border-top: 2px solid var(--primary-green);
            z-index: 2500;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .mobile-footer-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            height: 100%;
        }

        .footer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .footer-section.footer-center {
            flex: 1.2;
        }

        .footer-btn {
            background: transparent;
            color: var(--dark-gray);
            border: none;
            border-radius: 8px;
            padding: 4px 6px;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            width: 100%;
            min-height: 50px;
            justify-content: center;
        }

        .footer-btn:hover, 
        .footer-btn:focus {
            color: var(--primary-green);
            background: rgba(124, 179, 66, 0.1);
            text-decoration: none;
        }

        .footer-btn.footer-main {
            background: var(--primary-green);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(124, 179, 66, 0.3);
        }

        .footer-btn.footer-main:hover {
            background: var(--dark-green);
            transform: scale(1.05);
            color: white;
        }

        .footer-btn i {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .footer-btn.footer-main i {
            font-size: 20px;
            margin-bottom: 0;
        }

        .footer-btn span {
            font-size: 8px;
            line-height: 1;
            font-weight: 500;
        }

        .footer-btn.footer-main span {
            font-size: 9px;
            font-weight: 600;
        }

        /* Responsive adjustments for map controls */
        @media (max-width: 768px) {
            /* Mobile header removed - using unified main-header */

            .mobile-footer {
                display: block;
            }

            .main-content {
                margin-top: 70px;
                margin-bottom: 70px;
                height: calc(100vh - 140px);
                margin-right: 0 !important;
            }

            #map {
                height: 100% !important;
            }

            .sidebar {
                top: 70px;
                height: calc(100vh - 70px);
            }

            .toggle-sidebar {
                top: 70px;
            }

            .map-layer-control,
            .map-tools-control {
                right: 10px !important;
                top: 70px !important;
                min-width: 180px;
                font-size: 12px;
            }

            .leaflet-control-custom {
                width: 35px;
                height: 35px;
            }

            .leaflet-control-custom i {
                line-height: 35px !important;
                font-size: 14px;
            }

            .analytics-sidebar {
                top: 70px;
                height: calc(100vh - 70px);
                width: 280px;
                right: -280px;
            }

            .analytics-sidebar.visible {
                right: 0;
            }

            .analytics-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Camadas */
        .layers-subtitle {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-item {
            background: var(--light-green);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-green);
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: var(--secondary-green);
            transform: translateY(-1px);
        }

        .layer-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 5px;
        }

        .layer-item-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-green);
        }

        .layer-item-type {
            font-size: 11px;
            color: var(--dark-gray);
            opacity: 0.8;
        }

        .layer-controls {
            display: flex;
            gap: 5px;
        }

        .layer-controls .btn {
            padding: 2px 6px;
            font-size: 10px;
        }

        /* Modal customizations */
        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .modal-footer {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        /* Analytics Card */
        .analytics-card {
            position: absolute;
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 320px;
            border: 2px solid var(--primary-green);
            transition: all 0.3s ease;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .analytics-header h6 {
            font-size: 16px;
            color: var(--dark-green);
            font-weight: 600;
            margin: 0;
        }

        .analytics-controls {
            display: flex;
            gap: 5px;
        }

        .analytics-minimize,
        .analytics-close {
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 3px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .analytics-minimize:hover {
            background: var(--light-green);
            color: var(--primary-green);
        }

        .analytics-close:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        .analytics-card.minimized .analytics-content {
            display: none;
        }

        .analytics-card.minimized {
            width: auto;
            min-width: 200px;
        }

        .analytics-content {
            font-size: 14px;
        }

        .analytics-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .analytics-title {
            font-size: 13px;
            color: var(--dark-green);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .analytics-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark-gray);
        }

        .analytics-subtitle {
            font-size: 11px;
            color: var(--dark-gray);
            opacity: 0.8;
        }

        /* Painel Lateral Direito para Dados Analíticos */
        .analytics-sidebar {
            position: fixed;
            top: 70px;
            right: -350px;
            width: 350px;
            height: calc(100vh - 70px);
            background: var(--white);
            color: var(--dark-gray);
            overflow-y: auto;
            z-index: 1000;
            box-shadow: -2px 0 15px rgba(0,0,0,0.1);
            border-left: 1px solid var(--medium-gray);
            transition: right 0.3s ease;
        }

        .analytics-sidebar.visible {
            right: 0;
        }

        .analytics-sidebar-header {
            padding: 20px;
            background: var(--primary-green);
            color: white;
            border-bottom: 2px solid var(--dark-green);
        }

        .analytics-sidebar-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .analytics-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .analytics-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .analytics-sidebar-content {
            padding: 20px;
        }

        .analytics-layer-info {
            background: var(--light-green);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-green);
        }

        .analytics-layer-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-green);
            margin-bottom: 5px;
        }

        .analytics-layer-type {
            font-size: 12px;
            color: var(--dark-gray);
            opacity: 0.8;
        }

        .analytics-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .analytics-stat-item {
            background: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .analytics-stat-label {
            font-size: 11px;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .analytics-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark-green);
        }

        .analytics-chart-section {
            margin-bottom: 25px;
        }

        .analytics-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-green);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analytics-chart-container {
            background: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            padding: 15px;
            height: 250px;
        }

        .analytics-top-list {
            background: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            padding: 15px;
        }

        .analytics-top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-green);
        }

        .analytics-top-item:last-child {
            border-bottom: none;
        }

        .analytics-top-rank {
            font-weight: bold;
            color: var(--primary-green);
            margin-right: 10px;
        }

        .analytics-top-name {
            flex: 1;
            font-size: 12px;
            color: var(--dark-gray);
        }

        .analytics-top-value {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-green);
        }

        .analytics-export-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--light-green);
        }

        .analytics-export-btn {
            width: 100%;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .analytics-export-btn:hover {
            background: var(--dark-green);
        }

        .analytics-export-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Main Header -->
    <header class="main-header">
        <div class="header-left">
            <button class="hamburger-menu" id="toggle-sidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="header-center">
            <img src="/static/images/ferticore-logo-full.png" alt="FertiCore" class="header-logo">
        </div>
        <div class="header-right"></div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-subtitle">Sistema de Visualização Agrícola</div>
        </div>

        <ul class="sidebar-menu">
            <li>
                <a href="#" class="active">
                    <i class="fas fa-map"></i>
                    Mapa Principal
                </a>
            </li>
            <li>
                <a href="/analise-potencial">
                    <i class="fas fa-chart-line"></i>
                    Análise Comercial
                </a>
            </li>
            <li>
                <a href="/analise-territorial">
                    <i class="fas fa-map-marked-alt"></i>
                    Análise Territorial
                </a>
            </li>
            <li>
                <a href="/revendas">
                    <i class="fas fa-store"></i>
                    Cadastro de Revendas
                </a>
            </li>
            <li>
                <a href="/vendedores">
                    <i class="fas fa-user-plus"></i>
                    Cadastro de Vendedores
                    
                </a>
            </li>
            <li>
                <a href="/">
                    <i class="fas fa-download"></i>
                    Exportações
                </a>
            </li>
            <li>
                <a href="#" onclick="alert('Funcionalidade em desenvolvimento')">
                    <i class="fas fa-cog"></i>
                    Configurações
                </a>
            </li>
        </ul>

        <div class="layers-section">
            <div class="layers-title">
                <i class="fas fa-layer-group me-2"></i>
                Camadas
            </div>

            <button class="btn btn-success w-100 mb-3" id="add-layer-btn">
                <i class="fas fa-plus me-2"></i>
                Adicionar Camada
            </button>

            <div id="active-layers">
                <div class="layers-subtitle mb-2">Camadas Ativas</div>
                <div id="layers-list" class="mb-3">
                    <div class="text-muted text-center" style="font-size: 12px;">
                        Nenhuma camada ativa
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <div id="map"></div>

        <!-- Container for Analytics Cards (mantido para compatibilidade, mas não usado) -->
        <div id="analytics-cards-container" style="display: none;"></div>
    </div>

    <!-- Painel Lateral Direito para Dados Analíticos -->
    <div class="analytics-sidebar" id="analytics-sidebar">
        <div class="analytics-sidebar-header">
            <h3 class="analytics-sidebar-title">
                <span><i class="fas fa-chart-line me-2"></i>Dados Analíticos</span>
                <button class="analytics-close-btn" onclick="hideAnalyticsSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </h3>
        </div>

        <div class="analytics-sidebar-content" id="analytics-sidebar-content">
            <div class="text-center text-muted">
                <i class="fas fa-layer-group" style="font-size: 48px; opacity: 0.3;"></i>
                <p>Adicione uma camada para ver os dados analíticos</p>
            </div>
        </div>
    </div>

    <!-- Mobile Footer (only visible on mobile) -->
    <footer class="mobile-footer">
        <div class="mobile-footer-content">
            <div class="footer-section">
                <a href="/analise-territorial" class="footer-btn">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Análise Territorial</span>
                </a>
            </div>
            <div class="footer-section">
                <a href="/analise-potencial" class="footer-btn">
                    <i class="fas fa-chart-line"></i>
                    <span>Análise Comercial</span>
                </a>
            </div>
            <div class="footer-section footer-center">
                <a href="/" class="footer-btn footer-main">
                    <i class="fas fa-map"></i>
                    <span>Mapa</span>
                </a>
            </div>
            <div class="footer-section">
                <a href="/revendas" class="footer-btn">
                    <i class="fas fa-store"></i>
                    <span>Revendas</span>
                </a>
            </div>
            <div class="footer-section">
                <a href="/vendedores" class="footer-btn">
                    <i class="fas fa-user-plus"></i>
                    <span>Vendedores</span>
                </a>
            </div>
        </div>
    </footer>

    <!-- Modal para Adicionar Camada -->
    <div class="modal fade" id="layerModal" tabindex="-1" aria-labelledby="layerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-green); color: white;">
                    <h5 class="modal-title" id="layerModalLabel">
                        <i class="fas fa-layer-group me-2"></i>
                        Adicionar Nova Camada
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <label class="form-label">
                                    <i class="fas fa-layer-group me-1"></i>
                                    Tipo de Camada
                                </label>
                                <select id="layer-type-selector" class="form-select">
                                    <option value="">Selecione o tipo de camada...</option>
                                    <option value="crop">🌱 Culturas Agrícolas</option>
                                    <option value="fertilizer">🧪 Fertilizantes</option>
                                    <option value="agrotoxicos">🚫 Agrotóxicos</option>
                                    <option value="consultoria">📋 Consultoria Técnica</option>
                                    <option value="corretivos">⚗️ Corretivos</option>
                                    <option value="despesas">💰 Despesas</option>
                                    <option value="escolaridade">🎓 Escolaridade</option>
                                    <option value="receitas">💵 Receitas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Camada de Fertilizantes -->
                    <div id="fertilizer-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-flask me-2"></i>
                            Configurações da Camada de Fertilizantes
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="fertilizer-layer-name" class="form-control" placeholder="Ex: Estabelecimentos - São Paulo">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-flask me-1"></i>
                                        Categoria de Fertilizantes
                                    </label>
                                    <select id="modal-fertilizer-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-fertilizer-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-fertilizer-color-selector" class="form-select">
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#2196F3">Azul</option>
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Camada de Culturas -->
                    <div id="crop-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-leaf me-2"></i>
                            Configurações da Camada de Culturas
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="layer-name" class="form-control" placeholder="Ex: Soja - São Paulo">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-leaf me-1"></i>
                                        Cultura Agrícola
                                    </label>
                                    <select id="modal-crop-selector" class="form-select">
                                        <option value="">Selecione uma cultura...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-color-selector" class="form-select">
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#2196F3">Azul</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                Filtro por Raio (opcional)
                            </label>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="number" id="modal-radius-km" class="form-control" placeholder="Raio (km)" min="1" max="500">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" id="modal-radius-lat" class="form-control" placeholder="Latitude" step="any">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" id="modal-radius-lng" class="form-control" placeholder="Longitude" step="any">
                                </div>
                            </div>
                            <small class="text-muted">Deixe em branco para mostrar todos os municípios</small>
                        </div>
                    </div>

                    <!-- Configurações específicas para Agrotóxicos -->
                    <div id="agrotoxicos-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-ban me-2"></i>
                            Configurações da Camada de Agrotóxicos
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="agrotoxicos-layer-name" class="form-control" placeholder="Ex: Fungicidas - Brasil">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-ban me-1"></i>
                                        Categoria de Agrotóxicos
                                    </label>
                                    <select id="modal-agrotoxicos-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-agrotoxicos-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-agrotoxicos-color-selector" class="form-select">
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#2196F3">Azul</option>
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Consultoria Técnica -->
                    <div id="consultoria-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Configurações da Camada de Consultoria Técnica
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="consultoria-layer-name" class="form-control" placeholder="Ex: Assistência Técnica - São Paulo">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-clipboard-list me-1"></i>
                                        Categoria de Consultoria
                                    </label>
                                    <select id="modal-consultoria-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-consultoria-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-consultoria-color-selector" class="form-select">
                                        <option value="#2196F3">Azul</option>
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Corretivos -->
                    <div id="corretivos-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-vial me-2"></i>
                            Configurações da Camada de Corretivos
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="corretivos-layer-name" class="form-control" placeholder="Ex: Calcário - Brasil">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-vial me-1"></i>
                                        Categoria de Corretivos
                                    </label>
                                    <select id="modal-corretivos-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-corretivos-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-corretivos-color-selector" class="form-select">
                                        <option value="#795548">Marrom</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#2196F3">Azul</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Despesas -->
                    <div id="despesas-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-dollar-sign me-2"></i>
                            Configurações da Camada de Despesas
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="despesas-layer-name" class="form-control" placeholder="Ex: Despesas com Pessoal - Brasil">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>
                                        Categoria de Despesas
                                    </label>
                                    <select id="modal-despesas-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-despesas-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-despesas-color-selector" class="form-select">
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#2196F3">Azul</option>
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Escolaridade -->
                    <div id="escolaridade-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Configurações da Camada de Escolaridade
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="escolaridade-layer-name" class="form-control" placeholder="Ex: Ensino Superior - Brasil">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-graduation-cap me-1"></i>
                                        Categoria de Escolaridade
                                    </label>
                                    <select id="modal-escolaridade-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-escolaridade-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-escolaridade-color-selector" class="form-select">
                                        <option value="#2196F3">Azul</option>
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Receitas -->
                    <div id="receitas-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-money-bill-wave me-2"></i>
                            Configurações da Camada de Receitas
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="receitas-layer-name" class="form-control" placeholder="Ex: Receita Animal - Brasil">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-money-bill-wave me-1"></i>
                                        Categoria de Receitas
                                    </label>
                                    <select id="modal-receitas-selector" class="form-select">
                                        <option value="">Selecione uma categoria...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-map-marked-alt me-1"></i>
                                        Filtro por Estado
                                    </label>
                                    <select id="modal-receitas-state-selector" class="form-select">
                                        <option value="">Todos os estados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <select id="modal-receitas-color-selector" class="form-select">
                                        <option value="#4CAF50">Verde</option>
                                        <option value="#2196F3">Azul</option>
                                        <option value="#FF9800">Laranja</option>
                                        <option value="#9C27B0">Roxo</option>
                                        <option value="#607D8B">Cinza Azulado</option>
                                        <option value="#795548">Marrom</option>
                                        <option value="#F44336">Vermelho</option>
                                        <option value="#009688">Verde-azulado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações específicas para Revendas -->
                    <div id="revendas-layer-config" style="display: none;">
                        <hr>
                        <h6 class="mb-3">
                            <i class="fas fa-store me-2"></i>
                            Configurações da Camada de Revendas
                        </h6>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-store me-1"></i>
                                        Selecionar Revenda Cadastrada
                                    </label>
                                    <select class="form-select" id="revendas-selector">
                                        <option value="">Carregando revendas...</option>
                                    </select>
                                    <div class="form-text">
                                        <a href="/revendas" target="_blank" class="text-primary">
                                            <i class="fas fa-plus me-1"></i>
                                            Cadastrar nova revenda
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        Nome da Camada
                                    </label>
                                    <input type="text" id="revendas-layer-name" class="form-control"
                                           placeholder="Nome da camada será preenchido automaticamente" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-palette me-1"></i>
                                        Cor da Visualização
                                    </label>
                                    <input type="color" class="form-control form-control-color"
                                           id="revendas-color-selector" value="#FF5722">
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info" style="font-size: 13px;">
                            <i class="fas fa-info-circle me-2"></i>
                            A visualização mostrará o território de atuação da revenda selecionada no mapa.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="save-layer-btn">
                        <i class="fas fa-save me-1"></i>
                        Salvar Camada
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Exportação de Dados -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-green); color: white;">
                    <h5 class="modal-title" id="exportModalLabel">
                        <i class="fas fa-download me-2"></i>
                        Exportar Dados
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione a base de dados e o formato para exportar os dados:</p>
                    <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-database me-1"></i>
                                        Base de Dados
                                    </label>
                                    <select id="export-database-selector" class="form-select">
                                        <option value="">Selecione uma base...</option>
                                        <option value="crops">Culturas</option>
                                        <option value="fertilizers">Fertilizantes</option>
                                    </select>
                                </div>
                            </div>
                    <button class="btn btn-success w-100" id="download-complete-data" onclick="downloadCompleteData()">
                        <span id="download-icon" class="me-2">
                            <i class="fas fa-download"></i>
                        </span>
                        <span id="download-text">Baixar Base Completa (.xlsx)</span>
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom JS -->
    <script src="/static/js/map.js"></script>

    <script>
        // Sistema de camadas
        let activeLayers = [];
        let layerIdCounter = 1;
        let currentLegendControl = null; // Control global for legend

        // Tornar activeLayers acessível globalmente
        window.activeLayers = activeLayers;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize components
            initializeMap();
            loadCrops();
            loadFertilizerCategories();
            loadAgrotoxicosCategories();
            loadConsultoriaCategories();
            loadCorretivosCategories();
            loadDespesasCategories();
            loadEscolaridadeCategories();
            loadReceitasCategories();
            loadStates();
            loadRevendasForSelection(); // Load revendas for selection

            // Setup sidebar toggle
            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.getElementById('main-content');
                const toggleBtn = document.getElementById('toggle-sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                
                // Verificar se os elementos existem antes de prosseguir
                if (!sidebar || !toggleBtn) {
                    console.warn('Elementos do sidebar não encontrados');
                    return;
                }
                
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    // Mobile behavior
                    const isOpen = sidebar.classList.contains('active');
                    if (isOpen) {
                        sidebar.classList.remove('active');
                        if (overlay) overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    } else {
                        sidebar.classList.add('active');
                        if (overlay) overlay.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    }
                } else {
                    // Desktop behavior
                    sidebar.classList.toggle('hidden');
                    if (mainContent) mainContent.classList.toggle('sidebar-hidden');
                }

                // Change icon for toggle button
                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    const isOpen = (isMobile && sidebar.classList.contains('active')) ||
                                  (!isMobile && !sidebar.classList.contains('hidden'));
                    icon.className = isOpen ? 'fas fa-times' : 'fas fa-bars';
                }

                // Trigger map resize after sidebar animation
                setTimeout(() => {
                    if (window.map) {
                        window.map.invalidateSize();
                    }
                }, 300);
            }

            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            if (toggleSidebarBtn) {
                toggleSidebarBtn.addEventListener('click', toggleSidebar);
            }

            // Setup mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', toggleSidebar);
            }

            // Close sidebar when clicking overlay (mobile)
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    const sidebar = document.querySelector('.sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    const toggleBtn = document.getElementById('toggle-sidebar');

                    if (sidebar) sidebar.classList.remove('active');
                    if (overlay) overlay.classList.remove('active');
                    if (toggleBtn) {
                        const icon = toggleBtn.querySelector('i');
                        if (icon) icon.className = 'fas fa-bars';
                    }
                    document.body.style.overflow = '';
                });
            }

            // Handle window resize
            window.addEventListener('resize', function() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.getElementById('main-content');
                const overlay = document.getElementById('sidebar-overlay');
                const toggleBtn = document.getElementById('toggle-sidebar');

                // Verificar se os elementos existem
                if (!sidebar || !toggleBtn) return;

                if (window.innerWidth > 768) {
                    // Desktop: reset mobile classes
                    sidebar.classList.remove('active');
                    if (overlay) overlay.classList.remove('active');
                    document.body.style.overflow = '';
                } else {
                    // Mobile: reset desktop classes
                    sidebar.classList.remove('hidden');
                    if (mainContent) mainContent.classList.remove('sidebar-hidden');
                }

                // Reset icon
                const icon = toggleBtn.querySelector('i');
                if (icon) icon.className = 'fas fa-bars';

                // Trigger map resize
                if (window.map) {
                    window.map.invalidateSize();
                }
            });

            // Setup layer system
            document.getElementById('add-layer-btn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('layerModal'));
                modal.show();
            });

            // Setup layer type selector
            document.getElementById('layer-type-selector').addEventListener('change', function() {
                // Hide all configs first
                const configs = [
                    'crop-layer-config',
                    'fertilizer-layer-config',
                    'agrotoxicos-layer-config',
                    'consultoria-layer-config',
                    'corretivos-layer-config',
                    'despesas-layer-config',
                    'escolaridade-layer-config',
                    'receitas-layer-config',
                    'revendas-layer-config' // Add revendas config
                ];

                configs.forEach(configId => {
                    const element = document.getElementById(configId);
                    if (element) element.style.display = 'none';
                });

                // Show the selected config
                const selectedType = this.value;
                if (selectedType) {
                    const configElement = document.getElementById(`${selectedType}-layer-config`);
                    if (configElement) {
                        configElement.style.display = 'block';
                    }
                }
            });

            // Setup delimitation type selectors for each layer type
            const delimitationTypes = ['modal', 'modal-fertilizer'];
            delimitationTypes.forEach(prefix => {
                const selector = document.getElementById(`${prefix}-delimitation-type`);
                if (selector) {
                    selector.addEventListener('change', function() {
                        const type = this.value;
                        const stateSection = document.getElementById(`${prefix === 'modal' ? 'state' : prefix.replace('modal-', '') + '-state'}-delimitation-section`);
                        const revendaSection = document.getElementById(`${prefix === 'modal' ? 'revenda' : prefix.replace('modal-', '') + '-revenda'}-delimitation-section`);

                        // Hide both sections first
                        if (stateSection) stateSection.style.display = 'none';
                        if (revendaSection) revendaSection.style.display = 'none';

                        // Show the selected section
                        if (type === 'state' && stateSection) {
                            stateSection.style.display = 'block';
                        } else if (type === 'revenda' && revendaSection) {
                            revendaSection.style.display = 'block';
                        }
                    });
                }
            });

            // Setup save layer button
            document.getElementById('save-layer-btn').addEventListener('click', function() {
                saveLayer();
            });


        });

        async function loadCrops() {
            try {
                const response = await fetch('/api/crops');
                const data = await response.json();

                if (data.success) {
                    // Carregar no modal principal (se existir)
                    const selector = document.getElementById('crop-selector');
                    if (selector) {
                        selector.innerHTML = '<option value="">Selecione uma cultura...</option>';
                        data.crops.forEach(crop => {
                            const option = document.createElement('option');
                            option.value = crop;
                            option.textContent = crop;
                            selector.appendChild(option);
                        });
                    }

                    // Carregar no modal de camadas
                    const modalSelector = document.getElementById('modal-crop-selector');
                    if (modalSelector) {
                        modalSelector.innerHTML = '<option value="">Selecione uma cultura...</option>';
                        data.crops.forEach(crop => {
                            const option = document.createElement('option');
                            option.value = crop;
                            option.textContent = crop;
                            modalSelector.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar culturas:', error);
            }
        }

        async function loadFertilizerCategories() {
            try {
                const response = await fetch('/api/fertilizer-categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-fertilizer-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de fertilizantes:', error);
            }
        }

        async function loadAgrotoxicosCategories() {
            try {
                const response = await fetch('/api/agrotoxico/categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-agrotoxicos-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de agrotóxicos:', error);
            }
        }

        async function loadConsultoriaCategories() {
            try {
                const response = await fetch('/api/consultoria/categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-consultoria-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de consultoria:', error);
            }
        }

        async function loadCorretivosCategories() {
            try {
                const response = await fetch('/api/corretivos/categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-corretivos-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de corretivos:', error);
            }
        }

        async function loadDespesasCategories() {
            try {
                const response = await fetch('/api/despesa/categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-despesas-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de despesas:', error);
            }
        }

        async function loadEscolaridadeCategories() {
            try {
                const response = await fetch('/api/escolaridade/categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-escolaridade-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de escolaridade:', error);
            }
        }

        async function loadReceitasCategories() {
            try {
                const response = await fetch('/api/receita/categories');
                const data = await response.json();

                if (data.success) {
                    const selector = document.getElementById('modal-receitas-selector');
                    selector.innerHTML = '<option value="">Selecione uma categoria...</option>';

                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de receitas:', error);
            }
        }

        async function loadStates() {
            try {
                const response = await fetch('/api/brazilian-states');
                const data = await response.json();

                if (data.success) {
                    // Lista de todos os seletores de estado
                    const stateSelectors = [
                        'modal-state-selector',
                        'modal-fertilizer-state-selector',
                        'modal-agrotoxicos-state-selector',
                        'modal-consultoria-state-selector',
                        'modal-corretivos-state-selector',
                        'modal-despesas-state-selector',
                        'modal-escolaridade-state-selector',
                        'modal-receitas-state-selector'
                    ];

                    stateSelectors.forEach(selectorId => {
                        const selector = document.getElementById(selectorId);
                        if (selector) {
                            selector.innerHTML = '<option value="">Todos os estados</option>';
                            data.states.forEach(state => {
                                const option = document.createElement('option');
                                option.value = state.code;
                                option.textContent = `${state.name} (${state.code})`;
                                selector.appendChild(option);
                            });
                        }
                    });
                } else {
                    console.error('Erro ao carregar estados:', data.error);
                }
            } catch (error) {
                console.error('Erro ao carregar estados:', error);
            }
        }

        async function loadRevendasForSelection() {
            try {
                const response = await fetch('/api/revendas');
                const data = await response.json();

                if (data.success && data.revendas) {
                    // Lista de todos os seletores de revenda
                    const revendaSelectors = [
                        'revendas-selector',
                        'modal-revenda-selector',
                        'modal-fertilizer-revenda-selector'
                    ];

                    revendaSelectors.forEach(selectorId => {
                        const selector = document.getElementById(selectorId);
                        if (selector) {
                            selector.innerHTML = '<option value="">Selecione uma revenda...</option>';

                            data.revendas.forEach(revenda => {
                                const option = document.createElement('option');
                                option.value = revenda.id;
                                option.textContent = `${revenda.nome} (${revenda.municipios_count || 0} municípios)`;
                                option.dataset.nome = revenda.nome;
                                option.dataset.cor = revenda.cor;
                                option.dataset.territory = JSON.stringify(revenda.municipios || []);
                                selector.appendChild(option);
                            });
                        }
                    });

                    // Add event listener for revendas-selector (specific for revendas layer type)
                    const revendasSelector = document.getElementById('revendas-selector');
                    if (revendasSelector) {
                        revendasSelector.addEventListener('change', function() {
                            const selectedOption = this.selectedOptions[0];
                            if (selectedOption && selectedOption.value) {
                                const revendaName = selectedOption.dataset.nome;
                                const revendaCor = selectedOption.dataset.cor;

                                // Update layer name and color
                                document.getElementById('revendas-layer-name').value = `Território - ${revendaName}`;
                                document.getElementById('revendas-color-selector').value = revendaCor;
                            } else {
                                document.getElementById('revendas-layer-name').value = '';
                            }
                        });
                    }
                } else {
                    console.error('Erro ao carregar revendas:', data.error || 'Dados não encontrados');
                    const selector = document.getElementById('revendas-selector');
                    if (selector) {
                        selector.innerHTML = '<option value="">Nenhuma revenda cadastrada</option>';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar revendas:', error);
                const selector = document.getElementById('revendas-selector');
                if (selector) {
                    selector.innerHTML = '<option value="">Erro de conexão</option>';
                }
            }
        }


        function filterByState(stateCode) {
            if (window.filterByStateOnMap) {
                window.filterByStateOnMap(stateCode);
            }
        }

        function downloadCompleteData() {
            const database = document.getElementById('export-database-selector').value;
            if (!database) {
                alert('Por favor, selecione uma base de dados para exportar.');
                return;
            }

            const downloadBtn = document.getElementById('download-complete-data');
            const downloadIcon = document.getElementById('download-icon');
            const downloadText = document.getElementById('download-text');

            // Show loading state
            downloadBtn.disabled = true;
            downloadIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            downloadText.textContent = 'Processando download...';
            downloadBtn.classList.remove('btn-success');
            downloadBtn.classList.add('btn-warning');

            const downloadUrl = `/api/export/${database}`;

            // Create temporary link to download file
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${database}_complete_data.xlsx`;

            // Create a hidden iframe to handle the download and detect completion
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = downloadUrl;
            document.body.appendChild(iframe);

            // Listen for the iframe load event to detect download completion
            iframe.onload = function() {
                // Reset button state after download completes
                setTimeout(() => {
                    downloadBtn.disabled = false;
                    downloadIcon.innerHTML = '<i class="fas fa-download"></i>';
                    downloadText.textContent = 'Baixar Base Completa (.xlsx)';
                    downloadBtn.classList.remove('btn-warning');
                    downloadBtn.classList.add('btn-success');
                    document.body.removeChild(iframe);
                }, 1000);
            };

            // Fallback: reset after 30 seconds in case the detection fails
            setTimeout(() => {
                if (downloadBtn.disabled) {
                    downloadBtn.disabled = false;
                    downloadIcon.innerHTML = '<i class="fas fa-download"></i>';
                    downloadText.textContent = 'Baixar Base Completa (.xlsx)';
                    downloadBtn.classList.remove('btn-warning');
                    downloadBtn.classList.add('btn-success');
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }
            }, 30000);

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showAnalyticsCard(layer) {
            // Now uses the sidebar instead of floating cards
            showAnalyticsSidebar(layer);
        }

        function showAnalyticsSidebar(layer) {
            const sidebar = document.getElementById('analytics-sidebar');
            const content = document.getElementById('analytics-sidebar-content');
            const mainContent = document.getElementById('main-content');

            if (!sidebar || !content) {
                console.error('Sidebar analítico não encontrado');
                return;
            }

            // Show analytics sidebar only if layer is visible
            if (layer.visible === false) {
                hideAnalyticsSidebar();
                return;
            }

            // Show the sidebar and adjust the layout
            sidebar.classList.add('visible');
            mainContent.classList.add('analytics-visible');

            const layerName = layer.name || 'Camada Desconhecida';
            const layerId = layer.id;

            // Get filtered data for the layer
            const filteredLayerData = getFilteredDataForLayer(layer);

            // Calculate statistics based on filtered data
            const analytics = calculateLayerAnalytics(filteredLayerData, layer);

            // Determine correct unit based on type
            let unitSuffix = ' ha';
            let unitLabel = 'Hectares';
            if (layer.type === 'fertilizer' || layer.type === 'agrotoxicos' || layer.type === 'consultoria' || layer.type === 'escolaridade' || layer.type === 'corretivos') {
                unitSuffix = ' un';
                unitLabel = 'Un';
            } else if (layer.type === 'receitas' || layer.type === 'despesas') {
                unitSuffix = '';
                unitLabel = 'Reais (R$)';
            } else if (layer.type === 'crop') {
                unitSuffix = ' ha';
                unitLabel = 'Hectares (ha)';
            } else if (layer.type === 'revendas') {
                unitSuffix = ' mun.'; // Municipalities
                unitLabel = 'Municípios';
            }

            // Get top 5 municipalities from filtered data
            const top5 = getTop5Municipalities(filteredLayerData, layer);

            // Generate sidebar content
            content.innerHTML = `
                <div class="analytics-layer-info">
                    <div class="analytics-layer-name">${layerName}</div>
                    <div class="analytics-layer-type">
                        ${layer.type === 'crop' ? 'Cultura Agrícola' : layer.type === 'fertilizer' ? 'Fertilizante' : layer.type === 'agrotoxicos' ? 'Agrotóxico' : layer.type === 'consultoria' ? 'Consultoria Técnica' : layer.type === 'corretivos' ? 'Corretivo' : layer.type === 'despesas' ? 'Despesa' : layer.type === 'escolaridade' ? 'Escolaridade' : layer.type === 'receitas' ? 'Receita' : layer.type === 'revendas' ? 'Revenda' : ''}
                        ${layer.state ? ` - ${layer.state}` : ''}
                        ${layer.radius ? ` - Raio ${layer.radius.km}km` : ''}
                    </div>
                </div>

                <div class="analytics-stats-grid">
                    <div class="analytics-stat-item">
                        <div class="analytics-stat-label">Total</div>
                        <div class="analytics-stat-value">${analytics.totalValue}</div>
                    </div>
                    <div class="analytics-stat-item">
                        <div class="analytics-stat-label">Municípios</div>
                        <div class="analytics-stat-value">${analytics.municipalitiesCount}</div>
                    </div>
                    <div class="analytics-stat-item">
                        <div class="analytics-stat-label">Média/Mun.</div>
                        <div class="analytics-stat-value">${analytics.averageArea}</div>
                    </div>
                    <div class="analytics-stat-item">
                        <div class="analytics-stat-label">Estado</div>
                        <div class="analytics-stat-value">${analytics.region.name}</div>
                    </div>
                </div>

                ${top5.length > 0 ? `
                <div class="analytics-chart-section">
                    <div class="analytics-section-title">
                        <i class="fas fa-chart-bar"></i>
                        Top 5 Municípios
                    </div>
                    <div class="analytics-chart-container">
                        <canvas id="analytics-chart-${layerId}"></canvas>
                    </div>
                </div>

                <div class="analytics-chart-section">
                    <div class="analytics-section-title">
                        <i class="fas fa-list-ol"></i>
                        Ranking Detalhado
                    </div>
                    <div class="analytics-top-list">
                        ${top5.map((item, index) => `
                            <div class="analytics-top-item">
                                <span class="analytics-top-rank">${index + 1}º</span>
                                <span class="analytics-top-name">${item.name} (${item.state})</span>
                                <span class="analytics-top-value">${formatNumber(item.value)}${unitSuffix}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle" style="font-size: 24px;"></i>
                    <p>Sem dados suficientes para exibir o ranking e gráficos.</p>
                </div>
                `}

                <div class="analytics-export-section">
                    <div class="analytics-section-title">
                        <i class="fas fa-download"></i>
                        Exportar Dados
                    </div>
                    <button class="analytics-export-btn" onclick="exportLayerData(${layerId})" id="export-btn-${layerId}">
                        <i class="fas fa-file-excel"></i>
                        Exportar para Excel
                    </button>
                </div>
            `;

            // Create chart after DOM is updated
            if (top5.length > 0) {
                setTimeout(() => {
                    createAnalyticsChart(layerId, top5, unitSuffix);
                }, 100);
            }

            // Resize map after sidebar animation
            setTimeout(() => {
                if (window.map) {
                    window.map.invalidateSize();
                }
            }, 300);

            console.log(`Sidebar analítico mostrado para camada ${layerId}: ${layerName}`);
        }

        function hideAnalyticsSidebar() {
            const sidebar = document.getElementById('analytics-sidebar');
            const mainContent = document.getElementById('main-content');

            sidebar.classList.remove('visible');
            mainContent.classList.remove('analytics-visible');

            // Trigger map resize after sidebar animation
            setTimeout(() => {
                if (window.map) {
                    window.map.invalidateSize();
                }
            }, 300);
        }

        function getTop5Municipalities(layerData, layer) {
            const municipalities = [];

            // Use layerData.data which is where the data is stored
            const data = layerData || {};

            for (const [municipalityCode, municipalityInfo] of Object.entries(data)) {
                const value = municipalityInfo.harvested_area || municipalityInfo.value || 0;
                if (value > 0) {
                    municipalities.push({
                        code: municipalityCode,
                        name: municipalityInfo.municipality_name || 'Desconhecido',
                        state: municipalityInfo.state_code || 'XX',
                        value: value
                    });
                }
            }

            municipalities.sort((a, b) => b.value - a.value);
            return municipalities.slice(0, 5);
        }

        function createAnalyticsChart(layerId, top5Data, unitSuffix) {
            const chartId = `analytics-chart-${layerId}`;
            const ctx = document.getElementById(chartId);

            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top5Data.map(item => `${item.name} (${item.state})`),
                    datasets: [{
                        label: `Valor${unitSuffix}`,
                        data: top5Data.map(item => item.value),
                        backgroundColor: 'rgba(124, 179, 66, 0.8)',
                        borderColor: 'rgba(124, 179, 66, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value) + unitSuffix;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4
                        }
                    }
                }
            });
        }

        function exportLayerData(layerId) {
            const layer = window.activeLayers.find(l => l.id === layerId);
            if (!layer) {
                alert('Camada não encontrada');
                return;
            }

            const exportBtn = document.getElementById(`export-btn-${layerId}`);
            const originalHTML = exportBtn.innerHTML;

            // Show loading state
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...';

            let exportUrl;
            let layerIdentifier;

            // Determine export URL based on layer type
            if (layer.type === 'crop') {
                layerIdentifier = layer.crop || layer.name;
                exportUrl = `/api/export/crop-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'fertilizer') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/fertilizer-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'agrotoxicos') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/agrotoxico-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'consultoria') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/consultoria-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'corretivos') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/corretivos-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'despesas') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/despesa-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'escolaridade') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/escolaridade-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'receitas') {
                layerIdentifier = layer.category || layer.name;
                exportUrl = `/api/export/receita-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else if (layer.type === 'revendas') {
                // Assuming export for Revendas is based on name or CNPJ
                layerIdentifier = layer.name || layer.cnpj || layer.id;
                exportUrl = `/api/export/revenda-analysis/${encodeURIComponent(layerIdentifier)}`;
            } else {
                alert('Tipo de camada não suportado para exportação');
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalHTML;
                return;
            }

            // Add state filter if available
            if (layer.state) {
                exportUrl += `?state=${layer.state}`;
            }

            try {
                // Create download element
                const link = document.createElement('a');
                link.href = exportUrl;
                link.download = `analise_${layer.name.replace(/[^a-zA-Z0-9]/g, '_')}.xlsx`;
                link.style.display = 'none';

                // Append to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success feedback
                setTimeout(() => {
                    exportBtn.innerHTML = '<i class="fas fa-check"></i> Exportado!';
                    exportBtn.style.background = '#28a745';
                }, 500);

            } catch (error) {
                console.error('Erro na exportação:', error);
                alert('Erro ao iniciar o download. Tente novamente.');
            }

            // Restore button after a delay
            setTimeout(() => {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalHTML;
                exportBtn.style.background = '';
            }, 3000);
        }

        function removeAnalyticsCard(layerId) {
            // When a layer is removed/hidden, hide the sidebar if it was the active layer
            const sidebar = document.getElementById('analytics-sidebar');
            const mainContent = document.getElementById('main-content');
            const visibleLayerIds = window.activeLayers.filter(l => l.visible !== false).map(l => l.id);

            // If the currently displayed layer's ID matches the removed layer's ID, hide the sidebar
            // Or if no layers are visible anymore
            if (sidebar.classList.contains('visible')) {
                const sidebarTitleSpan = sidebar.querySelector('.analytics-sidebar-title span');
                if (sidebarTitleSpan) {
                    const layerNameInSidebar = sidebarTitleSpan.textContent.trim();
                    const layerIdInSidebar = parseInt(sidebar.getAttribute('data-current-layer-id'));

                    if (layerIdInSidebar === layerId || visibleLayerIds.length === 0) {
                        hideAnalyticsSidebar();
                    }
                } else if (visibleLayerIds.length === 0) {
                    hideAnalyticsSidebar();
                }
            }
        }

        function clearAllAnalyticsCards() {
            hideAnalyticsSidebar();
        }

        function toggleAnalyticsCard(layerId) {
            const card = document.getElementById(`analytics-card-${layerId}`);
            if (!card) return;

            const cardContent = card.querySelector('.analytics-content');
            const minimizeBtn = card.querySelector('.analytics-minimize i');

            card.classList.toggle('minimized');

            if (card.classList.contains('minimized')) {
                minimizeBtn.className = 'fas fa-plus';
                if (cardContent) cardContent.style.display = 'none';
            } else {
                minimizeBtn.className = 'fas fa-minus';
                if (cardContent) cardContent.style.display = 'block';
            }
        }

        function calculateCardPosition(cardIndex) {
            const baseTop = 20;
            const baseLeft = 20;
            const cardHeight = 380; // Approximate card height
            const cardWidth = 340;
            const margin = 20;

            // Organize cards in columns
            const cardsPerColumn = Math.floor((window.innerHeight - 100) / (cardHeight + margin));
            const column = Math.floor(cardIndex / cardsPerColumn);
            const row = cardIndex % cardsPerColumn;

            return {
                top: baseTop + (row * (cardHeight + margin)),
                left: baseLeft + (column * (cardWidth + margin))
            };
        }

        function repositionAnalyticsCards() {
            const container = document.getElementById('analytics-cards-container');
            const cards = container.querySelectorAll('.analytics-card');

            cards.forEach((card, index) => {
                const position = calculateCardPosition(index);
                card.style.top = `${position.top}px`;
                card.style.left = `${position.left}px`;
            });
        }

        function updateAnalyticsCard(card, layerData) {
            const filteredCropData = getFilteredDataForLayer(layerData);
            const analytics = calculateLayerAnalytics(filteredCropData, layerData);
            const layerName = layerData.name || 'Camada Desconhecida';

            // Update existing card content
            const sections = card.querySelectorAll('.analytics-section');
            sections[0].querySelector('.analytics-value').textContent = layerName;
            sections[1].querySelector('.analytics-value').textContent = analytics.totalValue;
            sections[2].querySelector('.analytics-value').textContent = analytics.municipalitiesCount;
            sections[3].querySelector('.analytics-value').textContent = analytics.topMunicipality.name;
            sections[3].querySelector('.analytics-subtitle').textContent = analytics.topMunicipality.value;
            sections[4].querySelector('.analytics-value').textContent = analytics.averageArea;
            sections[5].querySelector('.analytics-value').textContent = analytics.region.name;
            sections[5].querySelector('.analytics-subtitle').textContent = analytics.region.details;
        }

        function getFilteredDataForLayer(layerData) {
            // Use layerData.data which is where the data is stored
            const allData = layerData.data || {};
            const filteredData = {};

            // Always apply state filter if specified
            if (layerData.state) {
                for (const [municipalityCode, data] of Object.entries(allData)) {
                    if (data && data.state_code === layerData.state) {
                        filteredData[municipalityCode] = data;
                    }
                }

                // If there's also a radius filter, apply it to the already state-filtered data
                if (layerData.radius && layerData.mapLayer) {
                    const radiusFilteredData = {};
                    layerData.mapLayer.eachLayer(function(featureLayer) {
                        if (featureLayer.feature && featureLayer.feature.properties) {
                            const municipalityCode = featureLayer.feature.properties.GEOCODIGO ||
                                                   featureLayer.feature.properties.CD_MUN ||
                                                   featureLayer.feature.properties.cd_geocmu ||
                                                   featureLayer.feature.properties.geocodigo ||
                                                   featureLayer.feature.properties.CD_GEOCMU;

                            if (municipalityCode && filteredData[municipalityCode]) {
                                radiusFilteredData[municipalityCode] = filteredData[municipalityCode];
                            }
                        }
                    });
                    return radiusFilteredData;
                }

                return filteredData;
            }

            // If no state filter, but there's a mapLayer (e.g., radius filter only)
            if (layerData.mapLayer) {
                layerData.mapLayer.eachLayer(function(featureLayer) {
                    if (featureLayer.feature && featureLayer.feature.properties) {
                        const municipalityCode = featureLayer.feature.properties.GEOCODIGO ||
                                               featureLayer.feature.properties.CD_MUN ||
                                               featureLayer.feature.properties.cd_geocmu ||
                                               featureLayer.feature.properties.geocodigo ||
                                               featureLayer.feature.properties.CD_GEOCMU;

                        if (municipalityCode && allData[municipalityCode]) {
                            filteredData[municipalityCode] = allData[municipalityCode];
                        }
                    }
                });
                return filteredData;
            }

            // If no filters, return all data
            return allData;
        }

        function calculateLayerAnalytics(layerDataInput, layer) {
            const cropData = layerDataInput || {};
            const values = Object.values(cropData)
                .map(item => item.harvested_area || item.value || 0)
                .filter(value => value > 0);

            // Determine default unit based on type
            let defaultUnit = ' ha';
            let formattedDefault = '0 ha';
            if (layer.type === 'fertilizer' || layer.type === 'agrotoxicos' || layer.type === 'consultoria' || layer.type === 'escolaridade' || layer.type === 'corretivos') {
                defaultUnit = ' un';
                formattedDefault = '0 un';
            } else if (layer.type === 'receitas' || layer.type === 'despesas') {
                defaultUnit = ''; // No unit for currency
                formattedDefault = 'R$ 0,00'; // Formatted as Brazilian Real
            } else if (layer.type === 'revendas') {
                defaultUnit = ' mun.';
                formattedDefault = '0 mun.';
            }
            else {
                defaultUnit = ' ha';
                formattedDefault = '0 ha';
            }

            if (values.length === 0) {
                return {
                    totalValue: formattedDefault,
                    municipalitiesCount: '0',
                    averageArea: formattedDefault,
                    region: { name: 'N/A', percentage: 0 }
                };
            }

            const totalValue = values.reduce((sum, value) => sum + value, 0);
            const averageValue = totalValue / values.length;
            const municipalitiesCount = values.length;

            // Calculate dominant region
            const regionStats = {};
            for (const [municipalityCode, data] of Object.entries(cropData)) {
                const value = data.harvested_area || data.value || 0;
                if (value > 0) {
                    const region = data.state_code || 'XX';
                    regionStats[region] = (regionStats[region] || 0) + value;
                }
            }

            // Find dominant region
            let dominantRegion = 'N/A';
            let dominantPercentage = 0;
            for (const region in regionStats) {
                const percentage = (regionStats[region] / totalValue) * 100;
                if (percentage > dominantPercentage) {
                    dominantRegion = region;
                    dominantPercentage = percentage;
                }
            }

            // Determine unit and format based on type
            let unitSuffix = ' ha';
            let formattedTotal, formattedAverage;

            if (layer.type === 'receitas' || layer.type === 'despesas') {
                formattedTotal = totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                formattedAverage = Math.round(averageValue).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
            } else if (layer.type === 'fertilizer' || layer.type === 'agrotoxicos' || layer.type === 'consultoria' || layer.type === 'escolaridade' || layer.type === 'corretivos') {
                unitSuffix = ' un';
                formattedTotal = totalValue.toLocaleString('pt-BR') + unitSuffix;
                formattedAverage = Math.round(averageValue).toLocaleString('pt-BR') + unitSuffix;
            } else if (layer.type === 'revendas') {
                unitSuffix = ' mun.';
                formattedTotal = totalValue.toLocaleString('pt-BR') + unitSuffix;
                formattedAverage = Math.round(averageValue).toLocaleString('pt-BR') + unitSuffix;
            }
            else {
                // crop, corrective, etc.
                unitSuffix = ' ha';
                formattedTotal = totalValue.toLocaleString('pt-BR') + unitSuffix;
                formattedAverage = Math.round(averageValue).toLocaleString('pt-BR') + unitSuffix;
            }

            return {
                totalValue: formattedTotal,
                municipalitiesCount: municipalitiesCount.toLocaleString('pt-BR'),
                averageArea: formattedAverage,
                region: { name: dominantRegion, percentage: dominantPercentage.toFixed(1) }
            };
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toLocaleString('pt-BR', {maximumFractionDigits: 1}) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toLocaleString('pt-BR', {maximumFractionDigits: 0}) + 'k';
            } else {
                return num.toLocaleString('pt-BR', {maximumFractionDigits: 0});
            }
        }


        function saveLayer() {
            const layerType = document.getElementById('layer-type-selector').value;
            const editingLayerId = document.getElementById('layerModal').getAttribute('data-editing-layer-id');

            if (!layerType) {
                alert('Por favor, selecione um tipo de camada.');
                return;
            }

            let layerData = {};
            let isValid = false;

            // Configure data based on layer type
            switch (layerType) {
                case 'crop':
                    const layerName = document.getElementById('layer-name').value;
                    const crop = document.getElementById('modal-crop-selector').value;
                    const delimitationType = document.getElementById('modal-delimitation-type')?.value; // This is no longer used but kept for potential future use
                    const state = document.getElementById('modal-state-selector')?.value; // Use the direct state selector
                    const revendaId = null; // Revenda is removed
                    const color = document.getElementById('modal-color-selector').value;
                    const radiusKm = document.getElementById('modal-radius-km').value;
                    const radiusLat = document.getElementById('modal-radius-lat').value;
                    const radiusLng = document.getElementById('modal-radius-lng').value;

                    if (!layerName || !crop) {
                        alert('Por favor, preencha o nome da camada e selecione uma cultura.');
                        return;
                    }

                    layerData = {
                        type: 'crop',
                        name: layerName,
                        crop: crop,
                        state: state,
                        revendaId: revendaId,
                        delimitationType: delimitationType,
                        color: color,
                        radius: radiusKm ? {
                            km: parseInt(radiusKm),
                            lat: parseFloat(radiusLat),
                            lng: parseFloat(radiusLng)
                        } : null
                    };
                    isValid = true;
                    break;

                case 'fertilizer':
                    const fertilizerLayerName = document.getElementById('fertilizer-layer-name').value;
                    const fertilizerCategory = document.getElementById('modal-fertilizer-selector').value;
                    const fertilizerDelimitationType = document.getElementById('modal-fertilizer-delimitation-type')?.value; // No longer used but kept
                    const fertilizerState = document.getElementById('modal-fertilizer-state-selector')?.value;
                    const fertilizerRevendaId = null; // Revenda removed
                    const fertilizerColor = document.getElementById('modal-fertilizer-color-selector').value;

                    if (!fertilizerLayerName || !fertilizerCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'fertilizer',
                        name: fertilizerLayerName,
                        category: fertilizerCategory,
                        state: fertilizerState,
                        revendaId: fertilizerRevendaId,
                        delimitationType: fertilizerDelimitationType,
                        color: fertilizerColor
                    };
                    isValid = true;
                    break;

                case 'agrotoxicos':
                    const agrotoxicosLayerName = document.getElementById('agrotoxicos-layer-name').value;
                    const agrotoxicosCategory = document.getElementById('modal-agrotoxicos-selector').value;
                    const agrotoxicosState = document.getElementById('modal-agrotoxicos-state-selector').value;
                    const agrotoxicosColor = document.getElementById('modal-agrotoxicos-color-selector').value;

                    if (!agrotoxicosLayerName || !agrotoxicosCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'agrotoxicos',
                        name: agrotoxicosLayerName,
                        category: agrotoxicosCategory,
                        state: agrotoxicosState,
                        color: agrotoxicosColor
                    };
                    isValid = true;
                    break;

                case 'consultoria':
                    const consultoriaLayerName = document.getElementById('consultoria-layer-name').value;
                    const consultoriaCategory = document.getElementById('modal-consultoria-selector').value;
                    const consultoriaState = document.getElementById('modal-consultoria-state-selector').value;
                    const consultoriaColor = document.getElementById('modal-consultoria-color-selector').value;

                    if (!consultoriaLayerName || !consultoriaCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'consultoria',
                        name: consultoriaLayerName,
                        category: consultoriaCategory,
                        state: consultoriaState,
                        color: consultoriaColor
                    };
                    isValid = true;
                    break;

                case 'corretivos':
                    const corretivosLayerName = document.getElementById('corretivos-layer-name').value;
                    const corretivosCategory = document.getElementById('modal-corretivos-selector').value;
                    const corretivosState = document.getElementById('modal-corretivos-state-selector').value;
                    const corretivosColor = document.getElementById('modal-corretivos-color-selector').value;

                    if (!corretivosLayerName || !corretivosCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'corretivos',
                        name: corretivosLayerName,
                        category: corretivosCategory,
                        state: corretivosState,
                        color: corretivosColor
                    };
                    isValid = true;
                    break;

                case 'despesas':
                    const despesasLayerName = document.getElementById('despesas-layer-name').value;
                    const despesasCategory = document.getElementById('modal-despesas-selector').value;
                    const despesasState = document.getElementById('modal-despesas-state-selector').value;
                    const despesasColor = document.getElementById('modal-despesas-color-selector').value;

                    if (!despesasLayerName || !despesasCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'despesas',
                        name: despesasLayerName,
                        category: despesasCategory,
                        state: despesasState,
                        color: despesasColor
                    };
                    isValid = true;
                    break;

                case 'escolaridade':
                    const escolaridadeLayerName = document.getElementById('escolaridade-layer-name').value;
                    const escolaridadeCategory = document.getElementById('modal-escolaridade-selector').value;
                    const escolaridadeState = document.getElementById('modal-escolaridade-state-selector').value;
                    const escolaridadeColor = document.getElementById('modal-escolaridade-color-selector').value;

                    if (!escolaridadeLayerName || !escolaridadeCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'escolaridade',
                        name: escolaridadeLayerName,
                        category: escolaridadeCategory,
                        state: escolaridadeState,
                        color: escolaridadeColor
                    };
                    isValid = true;
                    break;

                case 'receitas':
                    const receitasLayerName = document.getElementById('receitas-layer-name').value;
                    const receitasCategory = document.getElementById('modal-receitas-selector').value;
                    const receitasState = document.getElementById('modal-receitas-state-selector').value;
                    const receitasColor = document.getElementById('modal-receitas-color-selector').value;

                    if (!receitasLayerName || !receitasCategory) {
                        alert('Por favor, preencha o nome da camada e selecione uma categoria.');
                        return;
                    }

                    layerData = {
                        type: 'receitas',
                        name: receitasLayerName,
                        category: receitasCategory,
                        state: receitasState,
                        color: receitasColor
                    };
                    isValid = true;
                    break;

                case 'revendas':
                    const revendasSelector = document.getElementById('revendas-selector');
                    const selectedRevendaId = revendasSelector.value;
                    const revendasLayerName = document.getElementById('revendas-layer-name').value;
                    const revendasColor = document.getElementById('revendas-color-selector').value;
                    const selectedRevendaOption = revendasSelector.selectedOptions[0];
                    const revendaTerritory = selectedRevendaOption ? JSON.parse(selectedRevendaOption.dataset.territory) : [];


                    if (!selectedRevendaId || !revendasLayerName) {
                        alert('Por favor, selecione uma revenda cadastrada.');
                        return;
                    }

                    layerData = {
                        type: 'revendas',
                        name: revendasLayerName,
                        revendaId: parseInt(selectedRevendaId),
                        color: revendasColor,
                        territory: revendaTerritory // Store territory data
                    };
                    isValid = true;
                    break;

                default:
                    alert('Tipo de camada não suportado.');
                    return;
            }

            if (!isValid) {
                alert('Erro ao validar dados da camada.');
                return;
            }

            // Process layer (editing or creation)
            if (editingLayerId) {
                // Editing existing layer
                const layerIndex = activeLayers.findIndex(l => l.id == editingLayerId);
                if (layerIndex !== -1) {
                    const existingLayer = activeLayers[layerIndex];

                    // Remove old map layer
                    if (existingLayer.mapLayer) {
                        map.removeLayer(existingLayer.mapLayer);
                    }

                    // Update layer data
                    activeLayers[layerIndex] = {
                        ...existingLayer,
                        ...layerData
                    };

                    applyLayer(activeLayers[layerIndex]);
                }
            } else {
                // Creating new layer
                const newLayer = {
                    id: Date.now(),
                    ...layerData
                };

                activeLayers.push(newLayer);
                applyLayer(newLayer);
            }

            // Sync activeLayers globally
            window.activeLayers = activeLayers;

            updateLayersList();

            // Close modal
            closeModal();
        }

        function updateLayersList() {
            const layersList = document.getElementById('layers-list');

            if (activeLayers.length === 0) {
                layersList.innerHTML = '<div class="text-muted text-center" style="font-size: 12px;">Nenhuma camada ativa</div>';
                updateStatistics();
                return;
            }

            layersList.innerHTML = activeLayers.map(layer => {
                const isVisible = layer.visible !== false;
                const eyeIcon = isVisible ? 'fa-eye' : 'fa-eye-slash';
                const eyeColor = isVisible ? 'btn-outline-primary' : 'btn-outline-secondary';

                return `
                <div class="layer-item" data-layer-id="${layer.id}" style="opacity: ${isVisible ? '1' : '0.6'};">
                    <div class="layer-item-header">
                        <div>
                            <div class="layer-item-name">${layer.name}</div>
                            <div class="layer-item-type">
                                ${layer.type === 'crop' ? 'Cultura' : layer.type === 'fertilizer' ? 'Fertilizante' : layer.type === 'agrotoxicos' ? 'Agrotóxico' : layer.type === 'consultoria' ? 'Consultoria' : layer.type === 'corretivos' ? 'Corretivo' : layer.type === 'despesas' ? 'Despesa' : layer.type === 'escolaridade' ? 'Escolaridade' : layer.type === 'receitas' ? 'Receita' : layer.type === 'revendas' ? 'Revenda' : ''}
                                ${layer.state ? ` - ${layer.state}` : ''}
                                ${layer.radius ? ` - Raio ${layer.radius.km}` : ''}
                            </div>
                        </div>
                        <div class="layer-controls">
                            <button class="btn btn-outline-info btn-sm" onclick="editLayer(${layer.id})" title="Editar camada">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeLayer(${layer.id})" title="Remover camada">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn ${eyeColor} btn-sm" onclick="toggleLayerVisibility(${layer.id})" title="Alternar visibilidade">
                                <i class="fas ${eyeIcon}"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <div style="width: 20px; height: 12px; background-color: ${layer.color}; border-radius: 3px; margin-right: 8px; border: 1px solid #ccc;"></div>
                        <span style="font-size: 11px; color: #666;">${layer.crop || layer.category || layer.name}</span>
                    </div>
                </div>
            `;
            }).join('');

            updateStatistics();
        }

        function applyLayer(layer) {
            // Dispatch to the appropriate loading function based on layer type
            loadLayerByType(layer);
        }

        function editLayer(layerId) {
            const layer = activeLayers.find(l => l.id === layerId);
            if (!layer) return;

            // Populate modal with layer data
            document.getElementById('layer-type-selector').value = layer.type;

            // Trigger change event to show the correct config panel
            const layerTypeSelector = document.getElementById('layer-type-selector');
            const changeEvent = new Event('change');
            layerTypeSelector.dispatchEvent(changeEvent);

            // Populate fields based on layer type
            switch (layer.type) {
                case 'crop':
                    document.getElementById('layer-name').value = layer.name;
                    document.getElementById('modal-crop-selector').value = layer.crop;
                    document.getElementById('modal-state-selector').value = layer.state || '';
                    document.getElementById('modal-color-selector').value = layer.color;
                    if (layer.radius) {
                        document.getElementById('modal-radius-km').value = layer.radius.km;
                        document.getElementById('modal-radius-lat').value = layer.radius.lat;
                        document.getElementById('modal-radius-lng').value = layer.radius.lng;
                    }
                    break;
                case 'fertilizer':
                    document.getElementById('fertilizer-layer-name').value = layer.name;
                    document.getElementById('modal-fertilizer-selector').value = layer.category;
                    document.getElementById('modal-fertilizer-state-selector').value = layer.state || '';
                    document.getElementById('modal-fertilizer-color-selector').value = layer.color;
                    break;
                case 'agrotoxicos':
                    document.getElementById('agrotoxicos-layer-name').value = layer.name;
                    document.getElementById('modal-agrotoxicos-selector').value = layer.category;
                    document.getElementById('modal-agrotoxicos-state-selector').value = layer.state || '';
                    document.getElementById('modal-agrotoxicos-color-selector').value = layer.color;
                    break;
                case 'consultoria':
                    document.getElementById('consultoria-layer-name').value = layer.name;
                    document.getElementById('modal-consultoria-selector').value = layer.category;
                    document.getElementById('modal-consultoria-state-selector').value = layer.state || '';
                    document.getElementById('modal-consultoria-color-selector').value = layer.color;
                    break;
                case 'corretivos':
                    document.getElementById('corretivos-layer-name').value = layer.name;
                    document.getElementById('modal-corretivos-selector').value = layer.category;
                    document.getElementById('modal-corretivos-state-selector').value = layer.state || '';
                    document.getElementById('modal-corretivos-color-selector').value = layer.color;
                    break;
                case 'despesas':
                    document.getElementById('despesas-layer-name').value = layer.name;
                    document.getElementById('modal-despesas-selector').value = layer.category;
                    document.getElementById('modal-despesas-state-selector').value = layer.state || '';
                    document.getElementById('modal-despesas-color-selector').value = layer.color;
                    break;
                case 'escolaridade':
                    document.getElementById('escolaridade-layer-name').value = layer.name;
                    document.getElementById('modal-escolaridade-selector').value = layer.category;
                    document.getElementById('modal-escolaridade-state-selector').value = layer.state || '';
                    document.getElementById('modal-escolaridade-color-selector').value = layer.color;
                    break;
                case 'receitas':
                    document.getElementById('receitas-layer-name').value = layer.name;
                    document.getElementById('modal-receitas-selector').value = layer.category;
                    document.getElementById('modal-receitas-state-selector').value = layer.state || '';
                    document.getElementById('modal-receitas-color-selector').value = layer.color;
                    break;
                case 'revendas':
                    document.getElementById('revendas-selector').value = layer.revendaId;
                    // Trigger change event to update layer name
                    const event = new Event('change');
                    document.getElementById('revendas-selector').dispatchEvent(event);
                    document.getElementById('revendas-color-selector').value = layer.color;
                    break;
            }

            // Store editing layer ID
            document.getElementById('layerModal').setAttribute('data-editing-layer-id', layerId);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('layerModal'));
            modal.show();
        }

        function removeLayer(layerId) {
            if (confirm('Tem certeza que deseja remover esta camada?')) {
                const layer = activeLayers.find(l => l.id === layerId);

                // Remove the layer from map if it exists
                if (layer && layer.mapLayer) {
                    map.removeLayer(layer.mapLayer);
                }

                // Remove analytics card for this layer
                if (window.removeAnalyticsCard) {
                    window.removeAnalyticsCard(layerId);
                }

                activeLayers = activeLayers.filter(layer => layer.id !== layerId);

                // If no more active layers, clear all analytics cards
                if (activeLayers.length === 0 && window.clearAllAnalyticsCards) {
                    window.clearAllAnalyticsCards();
                }

                updateLayersList();

                // Update legend using global function
                if (window.updateCombinedLegend) {
                    window.updateCombinedLegend();
                }
            }
        }

        function updateStatistics() {
            const visibleLayers = activeLayers.filter(layer => layer.visible !== false);
            const uniqueCrops = new Set(activeLayers.map(layer => layer.crop || layer.category));

            // Calculate total municipalities with data and total hectares
            let totalMunicipalities = 0;
            let totalHectares = 0;

            visibleLayers.forEach(layer => {
                if (layer.data || layer.cropData) {
                    const layerData = layer.data || layer.cropData;
                    const layerMunicipalities = Object.keys(layerData).length;
                    totalMunicipalities += layerMunicipalities;

                    Object.values(layerData).forEach(data => {
                        const value = data.harvested_area || data.value || 0;
                        if (value > 0) {
                            totalHectares += value;
                        }
                    });
                }
            });

            // Update desktop sidebar elements
            const activeLayersCountEl = document.getElementById('active-layers-count');
            if (activeLayersCountEl) {
                activeLayersCountEl.textContent = activeLayers.length;
            }

            const activeCropsCountEl = document.getElementById('active-crops-count');
            if (activeCropsCountEl) {
                activeCropsCountEl.textContent = uniqueCrops.size;
            }

            const municipalitiesWithDataEl = document.getElementById('municipalities-with-data');
            if (municipalitiesWithDataEl) {
                municipalitiesWithDataEl.textContent = totalMunicipalities.toLocaleString('pt-BR');
            }

            const totalHectaresEl = document.getElementById('total-hectares');
            if (totalHectaresEl) {
                // Format hectares
                if (totalHectares >= 1000000) {
                    totalHectaresEl.textContent = (totalHectares / 1000000).toLocaleString('pt-BR', {maximumFractionDigits: 1}) + 'M';
                } else if (totalHectares >= 1000) {
                    totalHectaresEl.textContent = (totalHectares / 1000).toLocaleString('pt-BR', {maximumFractionDigits: 1}) + 'K';
                } else {
                    totalHectaresEl.textContent = totalHectares.toLocaleString('pt-BR');
                }
            }

            // Update mobile footer elements
            const mobileActiveLayersEl = document.getElementById('mobile-active-layers');
            if (mobileActiveLayersEl) {
                mobileActiveLayersEl.textContent = activeLayers.length;
            }

            const mobileMunicipalitiesEl = document.getElementById('mobile-municipalities');
            if (mobileMunicipalitiesEl) {
                if (totalMunicipalities >= 1000) {
                    mobileMunicipalitiesEl.textContent = (totalMunicipalities / 1000).toLocaleString('pt-BR', {maximumFractionDigits: 1}) + 'K';
                } else {
                    mobileMunicipalitiesEl.textContent = totalMunicipalities.toLocaleString('pt-BR');
                }
            }
        }

        function toggleLayerVisibility(layerId) {
            const layer = activeLayers.find(l => l.id === layerId);
            if (layer) {
                layer.visible = layer.visible !== false ? false : true;

                if (layer.mapLayer) {
                    if (layer.visible) {
                        map.addLayer(layer.mapLayer);
                        // Show analytics sidebar when layer becomes visible
                        showAnalyticsSidebar(layer);
                    } else {
                        map.removeLayer(layer.mapLayer);
                        // Hide analytics sidebar when layer becomes invisible
                        hideAnalyticsSidebar();
                    }
                }

                updateLayersList();

                // Update legend using global function
                if (window.updateCombinedLegend) {
                    window.updateCombinedLegend();
                }
            }
        }

        function resetLayerForm() {
            // Reset common fields
            document.getElementById('layer-type-selector').value = '';

            // Reset crop fields
            document.getElementById('layer-name').value = '';
            document.getElementById('modal-crop-selector').value = '';
            document.getElementById('modal-state-selector').value = '';
            document.getElementById('modal-color-selector').value = '#4CAF50';
            document.getElementById('modal-radius-km').value = '';
            document.getElementById('modal-radius-lat').value = '';
            document.getElementById('modal-radius-lng').value = '';

            // Reset fertilizer fields
            document.getElementById('fertilizer-layer-name').value = '';
            document.getElementById('modal-fertilizer-selector').value = '';
            document.getElementById('modal-fertilizer-state-selector').value = '';
            document.getElementById('modal-fertilizer-color-selector').value = '#FF9800';

            // Reset agrotoxicos fields
            document.getElementById('agrotoxicos-layer-name').value = '';
            document.getElementById('modal-agrotoxicos-selector').value = '';
            document.getElementById('modal-agrotoxicos-state-selector').value = '';
            document.getElementById('modal-agrotoxicos-color-selector').value = '#F44336';

            // Reset consultoria fields
            document.getElementById('consultoria-layer-name').value = '';
            document.getElementById('modal-consultoria-selector').value = '';
            document.getElementById('modal-consultoria-state-selector').value = '';
            document.getElementById('modal-consultoria-color-selector').value = '#2196F3';

            // Reset corretivos fields
            document.getElementById('corretivos-layer-name').value = '';
            document.getElementById('modal-corretivos-selector').value = '';
            document.getElementById('modal-corretivos-state-selector').value = '';
            document.getElementById('modal-corretivos-color-selector').value = '#795548';

            // Reset despesas fields
            document.getElementById('despesas-layer-name').value = '';
            document.getElementById('modal-despesas-selector').value = '';
            document.getElementById('modal-despesas-state-selector').value = '';
            document.getElementById('modal-despesas-color-selector').value = '#F44336';

            // Reset escolaridade fields
            document.getElementById('escolaridade-layer-name').value = '';
            document.getElementById('modal-escolaridade-selector').value = '';
            document.getElementById('modal-escolaridade-state-selector').value = '';
            document.getElementById('modal-escolaridade-color-selector').value = '#2196F3';

            // Reset receitas fields
            document.getElementById('receitas-layer-name').value = '';
            document.getElementById('modal-receitas-selector').value = '';
            document.getElementById('modal-receitas-state-selector').value = '';
            document.getElementById('modal-receitas-color-selector').value = '#4CAF50';

            // Reset revendas fields
            document.getElementById('revendas-selector').value = '';
            document.getElementById('revendas-layer-name').value = '';
            document.getElementById('revendas-color-selector').value = '#FF5722';


            // Hide all config panels
            const configs = [
                'crop-layer-config',
                'fertilizer-layer-config',
                'agrotoxicos-layer-config',
                'consultoria-layer-config',
                'corretivos-layer-config',
                'despesas-layer-config',
                'escolaridade-layer-config',
                'receitas-layer-config',
                'revendas-layer-config' // Hide revendas config
            ];

            configs.forEach(configId => {
                const element = document.getElementById(configId);
                if (element) element.style.display = 'none';
            });

            document.getElementById('layerModal').removeAttribute('data-editing-layer-id');
        }

        // Helper function to load data and apply layer based on type
        function loadLayerByType(layer) {
            switch (layer.type) {
                case 'crop':
                    loadCropLayerForLayer(layer);
                    break;
                case 'fertilizer':
                    loadFertilizerLayerForLayer(layer);
                    break;
                case 'agrotoxicos':
                    loadAgrotoxicosLayerForLayer(layer);
                    break;
                case 'consultoria':
                    loadConsultoriaLayerForLayer(layer);
                    break;
                case 'corretivos':
                    loadCorretivosLayerForLayer(layer);
                    break;
                case 'despesas':
                    loadDespesasLayerForLayer(layer);
                    break;
                case 'escolaridade':
                    loadEscolaridadeLayerForLayer(layer);
                    break;
                case 'receitas':
                    loadReceitasLayerForLayer(layer);
                    break;
                case 'revendas':
                    loadRevendasLayerForLayer(layer); // Call the correct handler for revendas
                    break;
                default:
                    console.error('Tipo de camada não suportado para carregamento:', layer.type);
            }
        }


        async function loadFertilizerLayerForLayer(layer) {
            try {
                console.log(`Loading fertilizer layer for layer: ${layer.name}`);

                const response = await fetch(`/api/fertilizer-data/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const fertilizerData = data.data;

                    // Store layer data for analytics
                    layer.data = fertilizerData;

                    // Calculate min/max for this specific category
                    const values = Object.values(fertilizerData)
                        .map(item => item.harvested_area)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    // Store minMax in layer
                    layer.minMax = minMax;

                    await loadMunicipalityBoundariesForFertilizerLayer(layer, fertilizerData, minMax);

                    // Show analytics card
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading fertilizer data:', data.error);
                    alert('Erro ao carregar dados de fertilizantes: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de fertilizantes');
            }
        }

        async function loadAgrotoxicosLayerForLayer(layer) {
            try {
                console.log(`Loading agrotoxicos layer for layer: ${layer.name}`);

                const response = await fetch(`/api/agrotoxico/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const agrotoxicosData = data.data;
                    layer.data = agrotoxicosData;

                    const values = Object.values(agrotoxicosData)
                        .map(item => item.value || item.harvested_area || 0)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    layer.minMax = minMax;
                    await loadMunicipalityBoundariesForGenericLayer(layer, agrotoxicosData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading agrotoxicos data:', data.error);
                    alert('Erro ao carregar dados de agrotóxicos: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de agrotóxicos');
            }
        }

        async function loadConsultoriaLayerForLayer(layer) {
            try {
                console.log(`Loading consultoria layer for layer: ${layer.name}`);

                const response = await fetch(`/api/consultoria/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const consultoriaData = data.data;
                    layer.data = consultoriaData;

                    const values = Object.values(consultoriaData)
                        .map(item => item.value || item.harvested_area || 0)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    layer.minMax = minMax;
                    await loadMunicipalityBoundariesForGenericLayer(layer, consultoriaData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading consultoria data:', data.error);
                    alert('Erro ao carregar dados de consultoria: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de consultoria');
            }
        }

        async function loadCorretivosLayerForLayer(layer) {
            try {
                console.log(`Loading corretivos layer for layer: ${layer.name}`);

                const response = await fetch(`/api/corretivos/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const corretivosData = data.data;
                    layer.data = corretivosData;

                    const values = Object.values(corretivosData)
                        .map(item => item.value || item.harvested_area || 0)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    layer.minMax = minMax;
                    await loadMunicipalityBoundariesForGenericLayer(layer, corretivosData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading corretivos data:', data.error);
                    alert('Erro ao carregar dados de corretivos: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de corretivos');
            }
        }

        async function loadDespesasLayerForLayer(layer) {
            try {
                console.log(`Loading despesas layer for layer: ${layer.name}`);

                const response = await fetch(`/api/despesa/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const despesasData = data.data;
                    layer.data = despesasData;

                    const values = Object.values(despesasData)
                        .map(item => item.value || item.harvested_area || 0)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    layer.minMax = minMax;
                    await loadMunicipalityBoundariesForGenericLayer(layer, despesasData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading despesas data:', data.error);
                    alert('Erro ao carregar dados de despesas: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de despesas');
            }
        }

        async function loadEscolaridadeLayerForLayer(layer) {
            try {
                console.log(`Loading escolaridade layer for layer: ${layer.name}`);

                const response = await fetch(`/api/escolaridade/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const escolaridadeData = data.data;
                    layer.data = escolaridadeData;

                    const values = Object.values(escolaridadeData)
                        .map(item => item.value || item.harvested_area || 0)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    layer.minMax = minMax;
                    await loadMunicipalityBoundariesForGenericLayer(layer, escolaridadeData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading escolaridade data:', data.error);
                    alert('Erro ao carregar dados de escolaridade: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de escolaridade');
            }
        }

        async function loadReceitasLayerForLayer(layer) {
            try {
                console.log(`Loading receitas layer for layer: ${layer.name}`);

                const response = await fetch(`/api/receita/${encodeURIComponent(layer.category)}`);
                const data = await response.json();

                if (data.success) {
                    const receitasData = data.data;
                    layer.data = receitasData;

                    const values = Object.values(receitasData)
                        .map(item => item.value || item.harvested_area || 0)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    layer.minMax = minMax;
                    await loadMunicipalityBoundariesForGenericLayer(layer, receitasData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading receitas data:', data.error);
                    alert('Erro ao carregar dados de receitas: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados de receitas');
            }
        }

        // New function to load and display revendas layer
        async function loadRevendasLayerForLayer(layer) {
            try {
                console.log(`Loading revendas layer: ${layer.name}`);

                // Use territory data from layer instead of making API call
                if (layer.territory && layer.territory.length > 0) {
                    const revendasData = {};

                    // Create data structure for each municipality in territory
                    layer.territory.forEach(municipioCode => {
                        // Find municipality name from crop data
                        let municipalityName = `Município ${municipioCode}`;
                        let stateCode = "XX";

                        // Search in crop data for real names
                        // This is a fallback, ideally we would have a dedicated lookup for municipality names
                        for (const [cropName, cropData] of Object.entries(window.CROP_DATA || {})) {
                            if (cropData[municipioCode]) {
                                municipalityName = cropData[municipioCode].municipality_name || municipalityName;
                                stateCode = cropData[municipioCode].state_code || stateCode;
                                break;
                            }
                        }

                        revendasData[municipioCode] = {
                            name: layer.name, // Use the layer name or specific revenda name
                            municipality_name: municipalityName,
                            state_code: stateCode,
                            territory: layer.territory, // Store the list of municipalities
                            value: layer.territory.length, // Use territory count for visualization
                            unit: 'território'
                        };
                    });

                    layer.data = revendasData;
                    layer.dataColumn = 'value'; // Use 'value' for revendas

                    // For revendas, use a fixed min/max for coloring or a scale based on territory count
                    const minMax = { min: 1, max: Math.max(...layer.territory.map(code => revendasData[code]?.value || 1)) || 10 };
                    layer.minMax = minMax;

                    await loadMunicipalityBoundariesForRevendasLayer(layer, revendasData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('No territory data found for revenda');
                    alert('Erro: Nenhum território definido para esta revenda');
                }
            } catch (error) {
                console.error('Error loading revendas layer:', error);
                alert('Erro ao carregar camada de revendas: ' + error.message);
            }
        }


        async function loadMunicipalityBoundariesForGenericLayer(layer, layerData, minMax) {
            const geoJsonFiles = [
                '/static/data/brazil_municipalities_all.geojson',
                '/attached_assets/brazil_municipalities_all_1752980285489.geojson',
                '/static/data/brazil_municipalities_combined.geojson',
                '/static/data/br_municipalities_simplified.geojson'
            ];

            for (const filePath of geoJsonFiles) {
                try {
                    console.log(`Tentando carregar: ${filePath}`);
                    const response = await fetch(filePath);
                    if (response.ok) {
                        const geoData = await response.json();
                        console.log(`GeoJSON carregado com sucesso: ${filePath}, ${geoData.features.length} municípios`);

                        // Apply state filter if one is selected
                        const filteredData = applyStateFilterForLayer(geoData, layer.state);

                        const mapLayer = L.geoJSON(filteredData, {
                            style: function(feature) {
                                return getFeatureStyleForGenericLayer(feature, layer, layerData, minMax);
                            },
                            onEachFeature: function(feature, mapFeature) {
                                setupFeaturePopupForGenericLayer(feature, mapFeature, layer, layerData);
                            }
                        });

                        layer.mapLayer = mapLayer;
                        layer.minMax = minMax;
                        layer.data = layerData;

                        // Add to map if visible
                        if (layer.visible !== false) {
                            mapLayer.addTo(map);
                        }

                        // Update combined legend
                        updateCombinedLegend();
                        break;
                    }
                } catch (error) {
                    console.log(`Erro ao carregar ${filePath}:`, error);
                    continue;
                }
            }
        }

        function getFeatureStyleForGenericLayer(feature, layer, layerData, minMax) {
            const municipalityCode = feature.properties.GEOCODIGO ||
                                   feature.properties.CD_MUN ||
                                   feature.properties.cd_geocmu ||
                                   feature.properties.geocodigo ||
                                   feature.properties.CD_GEOCMU;

            const municipalityData = layerData[municipalityCode];

            if (!municipalityData || (!municipalityData.harvested_area && !municipalityData.value) ||
                (municipalityData.harvested_area === 0 && municipalityData.value === 0)) {
                // Municipalities without data - light gray color
                return {
                    fillColor: '#E8E8E8',
                    weight: 0.3,
                    opacity: 0.8,
                    color: '#CCCCCC',
                    fillOpacity: 0.6
                };
            }

            const value = municipalityData.harvested_area || municipalityData.value || 0;
            const color = getColorForValueWithColor(value, minMax.min, minMax.max, layer.color);

            return {
                fillColor: color,
                weight: 0.3,
                opacity: 0.8,
                color: '#666666',
                fillOpacity: 0.7
            };
        }

        function setupFeaturePopupForGenericLayer(feature, mapFeature, layer, layerData) {
            const municipalityCode = feature.properties.GEOCODIGO || feature.properties.CD_MUN || feature.properties.cd_geocmu || feature.properties.geocodigo;
            const municipalityName = feature.properties.NOME || feature.properties.NM_MUN || feature.properties.nm_mun || feature.properties.nome || 'Nome não disponível';
            const stateUF = feature.properties.UF || feature.properties.SIGLA_UF || feature.properties.uf;
            const municipalityData = layerData[municipalityCode];

            let popupContent = `<strong>${municipalityName}</strong>`;
            if (stateUF) {
                popupContent += ` (${stateUF})`;
            }
            popupContent += `<br>`;

            if (municipalityData && (municipalityData.harvested_area || municipalityData.value)) {
                const value = municipalityData.harvested_area || municipalityData.value || 0;

                // Determine correct unit based on type
                let unit = ' ha';
                if (layer.type === 'fertilizer' || layer.type === 'agrotoxicos' || layer.type === 'consultoria' || layer.type === 'escolaridade' || layer.type === 'corretivos') {
                    unit = ' un';
                } else if (layer.type === 'receitas' || layer.type === 'despesas') {
                    // Use currency formatting for these types
                    popupContent += `
                        Categoria: ${layer.category}<br>
                        Valor: ${value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<br>
                        Código: ${municipalityCode}
                    `;
                }

                if (layer.type !== 'receitas' && layer.type !== 'despesas') {
                    let displayValue;
                    if (value >= 1000000) {
                        displayValue = (value / 1000000).toFixed(1) + 'M' + unit;
                    } else if (value >= 1000) {
                        displayValue = (value / 1000).toFixed(1) + 'K' + unit;
                    } else {
                        displayValue = Math.round(value).toLocaleString('pt-BR') + unit;
                    }

                    popupContent += `
                        Categoria: ${layer.category}<br>
                        Valor: ${displayValue}<br>
                        Código: ${municipalityCode}
                    `;
                }
            } else {
                popupContent += `
                    Categoria: ${layer.category}<br>
                    <em>Dados não disponíveis</em><br>
                    Código: ${municipalityCode || 'N/A'}
                `;
            }

            mapFeature.bindPopup(popupContent);
        }

        async function loadMunicipalityBoundariesForFertilizerLayer(layer, fertilizerData, minMax) {
            const geoJsonFiles = [
                '/static/data/brazil_municipalities_all.geojson',
                '/attached_assets/brazil_municipalities_all_1752980285489.geojson',
                '/static/data/brazil_municipalities_combined.geojson',
                '/static/data/br_municipalities_simplified.geojson'
            ];

            for (const filePath of geoJsonFiles) {
                try {
                    console.log(`Tentando carregar: ${filePath}`);
                    const response = await fetch(filePath);
                    if (response.ok) {
                        const geoData = await response.json();
                        console.log(`GeoJSON carregado com sucesso: ${filePath}, ${geoData.features.length} municípios`);

                        // Apply state filter if one is selected
                        const filteredData = applyStateFilterForLayer(geoData, layer.state);

                        const mapLayer = L.geoJSON(filteredData, {
                            style: function(feature) {
                                return getFeatureStyleForFertilizerLayer(feature, layer, fertilizerData, minMax);
                            },
                            onEachFeature: function(feature, mapFeature) {
                                setupFeaturePopupForFertilizerLayer(feature, mapFeature, layer, fertilizerData);
                            }
                        });

                        layer.mapLayer = mapLayer;
                        layer.minMax = minMax;
                        layer.data = fertilizerData;

                        // Add to map if visible
                        if (layer.visible !== false) {
                            mapLayer.addTo(map);
                        }

                        // Update combined legend
                        updateCombinedLegend();
                        break;
                    }
                } catch (error) {
                    console.log(`Erro ao carregar ${filePath}:`, error);
                    continue;
                }
            }
        }

        function getFeatureStyleForFertilizerLayer(feature, layer, fertilizerData, minMax) {
            const municipalityCode = feature.properties.GEOCODIGO ||
                                   feature.properties.CD_MUN ||
                                   feature.properties.cd_geocmu ||
                                   feature.properties.geocodigo ||
                                   feature.properties.CD_GEOCMU;

            const fertilizerMunicipalityData = fertilizerData[municipalityCode];

            if (!fertilizerMunicipalityData || !fertilizerMunicipalityData.harvested_area || fertilizerMunicipalityData.harvested_area === 0) {
                // Municipalities without data - light gray color
                return {
                    fillColor: '#E8E8E8',
                    weight: 0.3,
                    opacity: 0.8,
                    color: '#CCCCCC',
                    fillOpacity: 0.6
                };
            }

            const area = fertilizerMunicipalityData.harvested_area;
            const color = getColorForValueWithColor(area, minMax.min, minMax.max, layer.color);

            return {
                fillColor: color,
                weight: 0.3,
                opacity: 0.8,
                color: '#666666',
                fillOpacity: 0.7
            };
        }

        function setupFeaturePopupForFertilizerLayer(feature, mapFeature, layerData, fertilizerData) {
            const municipalityCode = feature.properties.GEOCODIGO || feature.properties.CD_MUN || feature.properties.cd_geocmu || feature.properties.geocodigo;
            const municipalityName = feature.properties.NOME || feature.properties.NM_MUN || feature.properties.nm_mun || feature.properties.nome || 'Nome não disponível';
            const stateUF = feature.properties.UF || feature.properties.SIGLA_UF || feature.properties.uf;
            const fertilizerMunicipalityData = fertilizerData[municipalityCode];

            let popupContent = `<strong>${municipalityName}</strong>`;
            if (stateUF) {
                popupContent += ` (${stateUF})`;
            }
            popupContent += `<br>`;

            if (fertilizerMunicipalityData && fertilizerMunicipalityData.harvested_area) {
                popupContent += `
                    Categoria: ${layerData.category}<br>
                    Estabelecimentos: ${fertilizerMunicipalityData.harvested_area.toLocaleString('pt-BR')} un<br>
                    Código: ${municipalityCode}
                `;
            } else {
                popupContent += `
                    Categoria: ${layerData.category}<br>
                    <em>Dados não disponíveis</em><br>
                    Código: ${municipalityCode || 'N/A'}
                `;
            }

            mapFeature.bindPopup(popupContent);
        }

        async function loadCropLayerForLayer(layer) {
            try {
                console.log(`Loading crop layer for layer: ${layer.name}`);

                const response = await fetch(`/api/crop-data/${encodeURIComponent(layer.crop)}`);
                const data = await response.json();

                if (data.success) {
                    const cropData = data.data;

                    // Store layer data for analytics
                    layer.data = cropData;

                    // Calculate min/max for this specific crop
                    const values = Object.values(cropData)
                        .map(item => item.harvested_area)
                        .filter(value => value > 0);

                    let minMax = { min: 0, max: 1000 };
                    if (values.length > 0) {
                        minMax.min = Math.min(...values);
                        minMax.max = Math.max(...values);
                    }

                    await loadMunicipalityBoundariesForLayer(layer, cropData, minMax);

                    // Show analytics card
                    showAnalyticsCard(layer);
                } else {
                    console.error('Error loading crop data:', data.error);
                    alert('Erro ao carregar dados da cultura: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Erro de conexão ao carregar dados da cultura');
            }
        }

        async function loadMunicipalityBoundariesForLayer(layer, cropData, minMax) {
            const geoJsonFiles = [
                '/static/data/brazil_municipalities_all.geojson',
                '/attached_assets/brazil_municipalities_all_1752980285489.geojson',
                '/static/data/brazil_municipalities_combined.geojson',
                '/static/data/br_municipalities_simplified.geojson'
            ];

            for (const filePath of geoJsonFiles) {
                try {
                    console.log(`Tentando carregar: ${filePath}`);
                    const response = await fetch(filePath);
                    if (response.ok) {
                        const geoData = await response.json();
                        console.log(`GeoJSON carregado com sucesso: ${filePath}, ${geoData.features.length} municípios`);

                        // Apply state filter if one is selected
                        const filteredData = applyStateFilterForLayer(geoData, layer.state);

                        const mapLayer = L.geoJSON(filteredData, {
                            style: function(feature) {
                                return getFeatureStyleForLayer(feature, layer, cropData, minMax);
                            },
                            onEachFeature: function(feature, mapFeature) {
                                setupFeaturePopupForLayer(feature, mapFeature, layer, cropData);
                            }
                        });

                        // Apply radius filter if specified
                        if (layer.radius) {
                            // Filter by radius logic would go here
                        }

                        // Store layer reference and data for analytics
                        layer.mapLayer = mapLayer;
                        layer.minMax = minMax;
                        layer.data = cropData;

                        // Add to map if visible
                        if (layer.visible !== false) {
                            mapLayer.addTo(map);
                        }

                        // Update combined legend
                        updateCombinedLegend();
                        break;
                    }
                } catch (error) {
                    console.log(`Erro ao carregar ${filePath}:`, error);
                    continue;
                }
            }
        }

        function applyStateFilterForLayer(geoData, stateFilter) {
            if (!stateFilter) {
                return geoData;
            }

            const filteredFeatures = geoData.features.filter(feature => {
                const stateUF = feature.properties.UF || feature.properties.SIGLA_UF || feature.properties.uf;
                return stateUF === stateFilter;
            });

            return {
                type: "FeatureCollection",
                features: filteredFeatures
            };
        }

        function getFeatureStyleForLayer(feature, layer, cropData, minMax) {
            const municipalityCode = feature.properties.GEOCODIGO ||
                                   feature.properties.CD_MUN ||
                                   feature.properties.cd_geocmu ||
                                   feature.properties.geocodigo ||
                                   feature.properties.CD_GEOCMU;

            const cropInfo = cropData[municipalityCode];

            if (!cropInfo || !cropInfo.harvested_area || cropInfo.harvested_area === 0) {
                // Municipalities without data - light gray color
                return {
                    fillColor: '#E8E8E8',
                    weight: 0.3,
                    opacity: 0.8,
                    color: '#CCCCCC',
                    fillOpacity: 0.6
                };
            }

            const area = cropInfo.harvested_area;
            const color = getColorForValueWithColor(area, minMax.min, minMax.max, layer.color);

            return {
                fillColor: color,
                weight: 0.3,
                opacity: 0.8,
                color: '#666666',
                fillOpacity: 0.7
            };
        }

        function setupFeaturePopupForLayer(feature, mapFeature, layer, cropData) {
            const municipalityCode = feature.properties.GEOCODIGO || feature.properties.CD_MUN || feature.properties.cd_geocmu || feature.properties.geocodigo;
            const municipalityName = feature.properties.NOME || feature.properties.NM_MUN || feature.properties.nm_mun || feature.properties.nome || 'Nome não disponível';
            const stateUF = feature.properties.UF || feature.properties.SIGLA_UF || feature.properties.uf;
            const cropInfo = cropData[municipalityCode];

            let popupContent = `<strong>${municipalityName}</strong>`;
            if (stateUF) {
                popupContent += ` (${stateUF})`;
            }
            popupContent += `<br>`;

            if (cropInfo && cropInfo.harvested_area) {
                popupContent += `
                    Camada: ${layer.name}<br>
                    Cultura: ${layer.crop}<br>
                    Área Colhida: ${cropInfo.harvested_area.toLocaleString('pt-BR')} hectares<br>
                    Código: ${municipalityCode}
                `;
            } else {
                popupContent += `
                    Camada: ${layer.name}<br>
                    Cultura: ${layer.crop}<br>
                    <em>Dados não disponíveis</em><br>
                    Código: ${municipalityCode || 'N/A'}
                `;
            }

            mapFeature.bindPopup(popupContent);
        }

        function getColorForValueWithColor(value, min, max, baseColor) {
            // If value is 0 or negative, but we want color for 1ha, use 1
            if (value <= 0) value = 1;

            // Adjust min and max values for better distribution
            const adjustedMin = Math.max(min, 1);
            const adjustedMax = Math.max(max, adjustedMin * 10);

            // Use logarithmic scale for better distribution
            const logMin = Math.log(adjustedMin);
            const logMax = Math.log(adjustedMax);
            const logValue = Math.log(Math.max(value, adjustedMin));
            const normalized = (logValue - logMin) / (logMax - logMin);

            // Generate sequential color based on the selected base color
            return generateSequentialColorWithBase(normalized, baseColor);
        }

        function generateSequentialColorWithBase(normalized, baseColor) {
            // Convert hex to RGB
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            // Convert RGB to HSL
            const rgbToHsl = (r, g, b) => {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return { h: h * 360, s: s * 100, l: l * 100 };
            };

            // Convert HSL to RGB
            const hslToRgb = (h, s, l) => {
                h /= 360; s /= 100; l /= 100;
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };

                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                return {
                    r: Math.round(r * 255),
                    g: Math.round(g * 255),
                    b: Math.round(b * 255)
                };
            };

            const baseRgb = hexToRgb(baseColor);
            if (!baseRgb) return baseColor;

            const baseHsl = rgbToHsl(baseRgb.r, baseRgb.g, baseRgb.b);

            // Create sequential scale: higher values = darker colors
            // Lightness varies from 85% (light) to 15% (dark)
            const lightness = 85 - (normalized * 70);

            // Maintain hue, slightly adjust saturation
            const saturation = Math.max(20, baseHsl.s - (normalized * 10));

            const newRgb = hslToRgb(baseHsl.h, saturation, lightness);
            return `#${((1 << 24) + (newRgb.r << 16) + (newRgb.g << 8) + newRgb.b).toString(16).slice(1)}`;
        }

        function updateCombinedLegend() {
            // Remove existing legend
            if (currentLegendControl) {
                map.removeControl(currentLegendControl);
                currentLegendControl = null;
            }

            const visibleLayers = activeLayers.filter(layer => layer.visible !== false && layer.mapLayer);

            if (visibleLayers.length === 0) return;

            if (window.currentLegendControl) {
                map.removeControl(window.currentLegendControl);
                window.currentLegendControl = null;
            }

            window.currentLegendControl = L.control({ position: 'bottomright' });
            window.currentLegendControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'map-legend');

                let legendHTML = `<h6><i class="fas fa-layer-group"></i> Camadas Ativas</h6>`;

                visibleLayers.forEach(layer => {
                    const { min, max } = layer.minMax || { min: 1, max: 1000 };
                    const adjustedMin = Math.max(min, 1);
                    const adjustedMax = Math.max(max, adjustedMin * 10);

                    let unitSuffix = ' ha';
                    let unitLabel = 'Hectares';
                    if (layer.type === 'fertilizer' || layer.type === 'agrotoxicos' || layer.type === 'consultoria' || layer.type === 'escolaridade' || layer.type === 'corretivos') {
                        unitSuffix = ' un';
                        unitLabel = 'Un';
                    } else if (layer.type === 'receitas' || layer.type === 'despesas') {
                        unitSuffix = '';
                        unitLabel = 'Reais (R$)';
                    } else if (layer.type === 'crop') {
                        unitSuffix = ' ha';
                        unitLabel = 'Hectares';
                    } else if (layer.type === 'revendas') {
                        unitSuffix = ' mun.'; // Municipalities
                        unitLabel = 'Municípios';
                    }


                    legendHTML += `<div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">`;
                    legendHTML += `<div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">${layer.name}</div>`;
                    legendHTML += `<div style="font-size: 10px; margin-bottom: 5px;">${unitLabel}</div>`;

                    // Create color scale
                    const steps = 4;
                    for (let i = 0; i < steps; i++) {
                        let value;
                        if (i === 0) {
                            value = adjustedMin;
                        } else if (i === steps - 1) {
                            value = adjustedMax;
                        } else {
                            const logMin = Math.log(adjustedMin);
                            const logMax = Math.log(adjustedMax);
                            const logValue = logMin + (logMax - logMin) * (i / (steps - 1));
                            value = Math.exp(logValue);
                        }

                        const color = getColorForValueWithColor(value, adjustedMin, adjustedMax, layer.color);

                        let displayValue;
                        if (unitLabel === 'Reais (R$)') {
                            displayValue = value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        } else if (value >= 1000000) {
                            displayValue = (value / 1000000).toFixed(1) + 'M';
                        } else if (value >= 1000) {
                            displayValue = (value / 1000).toFixed(1) + 'K';
                        } else {
                            displayValue = value.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
                        }

                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color}; width: 15px; height: 15px; display: inline-block; margin-right: 5px; border: 1px solid #ccc;"></div>
                                <span style="font-size: 9px;">${displayValue}${unitSuffix}</span>
                            </div>
                        `;
                    }
                    legendHTML += `</div>`;
                });

                legendHTML += `
                    <div class="legend-item mt-2" style="font-size: 10px; color: #666;">
                        <div class="legend-color" style="background-color: #E8E8E8; width: 15px; height: 15px; display: inline-block; margin-right: 5px; border: 1px solid #ccc;"></div>
                        <span style="font-size: 9px;">Sem dados</span>
                    </div>
                `;

                div.innerHTML = legendHTML;
                return div;
            };
            window.currentLegendControl.addTo(map);
        }

        function closeModal() {
            try {
                const modalElement = document.getElementById('layerModal');
                if (!modalElement) {
                    console.error('Modal element not found');
                    return;
                }

                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    // Fallback: create new instance and hide
                    const newModal = new bootstrap.Modal(modalElement);
                    newModal.hide();
                }

                // Reset form after a small delay to ensure modal is hidden
                setTimeout(() => {
                    resetLayerForm();
                }, 100);

            } catch (error) {
                console.error('Error closing modal:', error);

                // Force close modal using jQuery/Bootstrap methods if available
                const modalElement = document.getElementById('layerModal');
                if (modalElement) {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');

                    // Remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                }

                resetLayerForm();
            }
        }

        function filterByState(stateCode) {
            if (window.filterByStateOnMap) {
                window.filterByStateOnMap(stateCode);
            }
        }

        // Updated function to load and display revendas layer
        async function loadRevendasLayerForLayer(layer) {
            try {
                console.log(`Loading revendas layer: ${layer.name}`);

                // Use territory data from layer instead of making API call
                if (layer.territory && layer.territory.length > 0) {
                    const revendasData = {};

                    // Create data structure for each municipality in territory
                    layer.territory.forEach(municipioCode => {
                        // Find municipality name from crop data
                        let municipalityName = `Município ${municipioCode}`;
                        let stateCode = "XX";

                        // Search in crop data for real names
                        // This is a fallback, ideally we would have a dedicated lookup for municipality names
                        for (const [cropName, cropData] of Object.entries(window.CROP_DATA || {})) {
                            if (cropData[municipioCode]) {
                                municipalityName = cropData[municipioCode].municipality_name || municipalityName;
                                stateCode = cropData[municipioCode].state_code || stateCode;
                                break;
                            }
                        }

                        revendasData[municipioCode] = {
                            name: layer.name, // Use the layer name or specific revenda name
                            municipality_name: municipalityName,
                            state_code: stateCode,
                            territory: layer.territory, // Store the list of municipalities
                            value: layer.territory.length, // Use territory count for visualization
                            unit: 'território'
                        };
                    });

                    layer.data = revendasData;
                    layer.dataColumn = 'value'; // Use 'value' for revendas

                    // For revendas, use a fixed min/max for coloring or a scale based on territory count
                    const minMax = { min: 1, max: Math.max(...layer.territory.map(code => revendasData[code]?.value || 1)) || 10 };
                    layer.minMax = minMax;

                    await loadMunicipalityBoundariesForRevendasLayer(layer, revendasData, minMax);
                    showAnalyticsCard(layer);
                } else {
                    console.error('No territory data found for revenda');
                    alert('Erro: Nenhum território definido para esta revenda');
                }
            } catch (error) {
                console.error('Error loading revendas layer:', error);
                alert('Erro ao carregar camada de revendas: ' + error.message);
            }
        }


        async function loadMunicipalityBoundariesForRevendasLayer(layer, revendasData, minMax) {
            const geoJsonFiles = [
                '/static/data/brazil_municipalities_all.geojson',
                '/attached_assets/brazil_municipalities_all_1752980285489.geojson',
                '/static/data/brazil_municipalities_combined.geojson',
                '/static/data/br_municipalities_simplified.geojson'
            ];

            for (const filePath of geoJsonFiles) {
                try {
                    console.log(`Tentando carregar: ${filePath}`);
                    const response = await fetch(filePath);
                    if (response.ok) {
                        const geoData = await response.json();
                        console.log(`GeoJSON carregado com sucesso: ${filePath}, ${geoData.features.length} municípios`);

                        // Filter GeoJSON data based on the revenda's territory
                        const revendaTerritoryCodes = new Set(layer.territory);
                        const filteredFeatures = geoData.features.filter(feature => {
                            const municipalityCode = feature.properties.GEOCODIGO || feature.properties.CD_MUN || feature.properties.cd_geocmu || feature.properties.geocodigo || feature.properties.CD_GEOCMU;
                            return revendaTerritoryCodes.has(municipalityCode);
                        });

                        const mapLayer = L.geoJSON({ type: "FeatureCollection", features: filteredFeatures }, {
                            style: function(feature) {
                                return getFeatureStyleForRevendasLayer(feature, layer, revendasData, minMax);
                            },
                            onEachFeature: function(feature, mapFeature) {
                                setupFeaturePopupForRevendasLayer(feature, mapFeature, layer, revendasData);
                            }
                        });

                        layer.mapLayer = mapLayer;
                        layer.minMax = minMax;
                        layer.data = revendasData; // Store the revendas data keyed by municipality code

                        if (layer.visible !== false) {
                            mapLayer.addTo(map);
                        }

                        updateCombinedLegend();
                        break;
                    }
                } catch (error) {
                    console.log(`Erro ao carregar ${filePath}:`, error);
                    continue;
                }
            }
        }

        function getFeatureStyleForRevendasLayer(feature, layer, revendasData, minMax) {
            const municipalityCode = feature.properties.GEOCODIGO || feature.properties.CD_MUN || feature.properties.cd_geocmu || feature.properties.geocodigo || feature.properties.CD_GEOCMU;
            const revendaInfo = revendasData[municipalityCode]; // Get revenda info for this municipality

            if (!revendaInfo) { // Should not happen if filtering is correct, but as a fallback
                return {
                    fillColor: '#E8E8E8',
                    weight: 0.3,
                    opacity: 0.8,
                    color: '#CCCCCC',
                    fillOpacity: 0.6
                };
            }

            // Color based on number of municipalities served by the revenda (or simply the revenda's own color)
            const value = revendaInfo.value; // Use the 'value' field which is territory count
            const color = getColorForValueWithColor(value, minMax.min, minMax.max, layer.color);

            return {
                fillColor: color,
                weight: 0.3,
                opacity: 0.8,
                color: '#666666',
                fillOpacity: 0.7
            };
        }

        function setupFeaturePopupForRevendasLayer(feature, mapFeature, layer, revendasData) {
            const municipalityCode = feature.properties.GEOCODIGO || feature.properties.CD_MUN || feature.properties.cd_geocmu || feature.properties.geocodigo;
            const municipalityName = feature.properties.NOME || feature.properties.NM_MUN || feature.properties.nm_mun || feature.properties.nome || 'Nome não disponível';
            const stateUF = feature.properties.UF || feature.properties.SIGLA_UF || feature.properties.uf;
            const revendaInfo = revendasData[municipalityCode];

            let popupContent = `<strong>${municipalityName}</strong>`;
            if (stateUF) {
                popupContent += ` (${stateUF})`;
            }
            popupContent += `<br>`;

            if (revendaInfo) {
                popupContent += `
                    Revenda: ${revendaInfo.name}<br>
                    CNPJ: ${revendaInfo.cnpj || 'N/A'}<br>
                    Atende ${revendaInfo.territory.length} município(s)<br>
                    Código: ${municipalityCode}
                `;
            } else {
                popupContent += `
                    <em>Dados da Revenda não disponíveis</em><br>
                    Código: ${municipalityCode || 'N/A'}
                `;
            }

            mapFeature.bindPopup(popupContent);
        }

    </script>
</body>
</html>